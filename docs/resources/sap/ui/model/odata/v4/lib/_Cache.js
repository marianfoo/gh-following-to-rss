/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_GroupLock","./_Helper","./_Requestor","sap/base/Log","sap/base/util/isEmptyObject","sap/ui/base/SyncPromise","sap/ui/model/odata/ODataUtils"],function(e,t,i,n,s,r,o){"use strict";var a="sap.ui.model.odata.v4.lib._Cache",u=/\(\$uid=[-\w]+\)$/,h=/^\$inactive\./,l="@com.sap.vocabularies.Common.v1.Messages",c=/^-?\d+$/,d=/^([^(]*)(\(.*\))$/;function f(e,t,i,n){if(i.$count!==undefined){g(e,t,i,i.$count+n)}}function p(e,t){return t===""||e===t||e.startsWith(t+"/")}function g(e,i,n,s){if(typeof s==="string"){s=parseInt(s)}t.updateExisting(e,i,n,{$count:s})}function P(e,t,i,n,s,r){this.iActiveUsages=1;this.mChangeListeners={};this.fnGetOriginalResourcePath=s;this.iInactiveSince=Infinity;this.mPatchRequests={};this.oPendingRequestsPromise=null;this.mPostRequests={};this.sReportedMessagesPath=undefined;this.oRequestor=e;this.bSentRequest=false;this.bSortExpandSelect=n;this.setResourcePath(t);this.setQueryOptions(i);this.bSharedRequest=r}P.prototype._delete=function(i,n,s,o,a,u){var h=s.split("/"),l=h.pop(),d=c.test(l)?Number(l):undefined,f=h.join("/"),p=this;this.checkSharedRequest();this.addPendingRequest();return this.fetchValue(e.$cached,f).then(function(e){var s=P.from$skip(l,e),h=l?e[s]||e.$byPredicate[s]:e,c,g=t.getPrivateAnnotation(h,"predicate"),y=t.buildPath(f,Array.isArray(e)?g:l),m=t.getPrivateAnnotation(h,"transient");if(m){if(typeof m!=="string"){throw new Error("No 'delete' allowed while waiting for server response")}p.oRequestor.removePost(m,h);return undefined}if(h["$ui5.deleting"]){throw new Error("Must not delete twice: "+n)}h["$ui5.deleting"]=true;c={"If-Match":o||h};n+=p.oRequestor.buildQueryString(p.sMetaPath,p.mQueryOptions,true);return r.all([i&&p.oRequestor.request("DELETE",n,i.getUnlockedCopy(),c,undefined,undefined,undefined,undefined,t.buildPath(p.getOriginalResourcePath(h),y)).catch(function(e){if(e.status!==404){delete h["$ui5.deleting"];throw e}}),d===undefined&&!a&&p.requestCount(i||p.oRequestor.lockGroup("$auto",p)),i&&i.unlock()]).then(function(){if(Array.isArray(e)){u(p.removeElement(e,d,g,f),e)}else{if(l){t.updateExisting(p.mChangeListeners,f,e,P.makeUpdateData([l],null))}else{h["$ui5.deleted"]=true}u()}p.oRequestor.getModelInterface().reportStateMessages(p.sResourcePath,{},[y])})}).finally(function(){p.removePendingRequest()})};P.prototype.addPendingRequest=function(){var e;if(!this.oPendingRequestsPromise){this.oPendingRequestsPromise=new r(function(t){e=t});this.oPendingRequestsPromise.$count=0;this.oPendingRequestsPromise.$resolve=e}this.oPendingRequestsPromise.$count+=1};P.prototype.calculateKeyPredicate=function(e,i,n){var s,r=i[n];if(r&&r.$Key){s=t.getKeyPredicate(e,n,i);if(s){t.setPrivateAnnotation(e,"predicate",s)}}return s};P.prototype.checkSharedRequest=function(){if(this.bSharedRequest){throw new Error(this+" is read-only")}};P.prototype.create=function(e,i,n,s,o,a,u,l){var c=this.getValue(n),d=e.getGroupId(),p=o&&o["@$ui5.keepTransientPath"],g,P,y=this;function m(){t.removeByPath(y.mPostRequests,n,o);c.splice(c.indexOf(o),1);c.$created-=1;if(!o["@$ui5.context.isInactive"]){y.iActiveElements-=1;f(y.mChangeListeners,n,c,-1)}delete c.$byPredicate[s];if(!n){y.adjustReadRequests(0,-1)}e.cancel()}function v(){y.addPendingRequest();t.setPrivateAnnotation(o,"transient",new Promise(function(e){P=e}));l()}function R(e,i){t.setPrivateAnnotation(o,"transient",d);t.addByPath(y.mPostRequests,n,o);return r.all([y.oRequestor.request("POST",e,i,null,g,v,m,undefined,t.buildPath(y.sResourcePath,n,s)),y.fetchTypes()]).then(function(e){var i=e[0],r,a;t.deletePrivateAnnotation(o,"postBody");t.deletePrivateAnnotation(o,"transient");o["@$ui5.context.isTransient"]=false;t.removeByPath(y.mPostRequests,n,o);y.visitResponse(i,e[1],t.getMetaPath(t.buildPath(y.sMetaPath,n)),n+s,p);r=t.getPrivateAnnotation(i,"predicate");if(r){t.setPrivateAnnotation(o,"predicate",r);if(p){r=s}else if(s in c.$byPredicate){c.$byPredicate[r]=o;t.updateTransientPaths(y.mChangeListeners,s,r)}}a=t.getQueryOptionsForPath(y.mQueryOptions,n).$select;t.updateSelected(y.mChangeListeners,t.buildPath(n,r||s),o,i,a);y.removePendingRequest();P(true);return o},function(t){if(t.canceled){throw t}if(P){y.removePendingRequest();P()}u(t);if(y.fetchTypes().isRejected()){throw t}d=d.replace(h,"");d=y.oRequestor.getGroupSubmitMode(d)==="API"?d:"$parked."+d;return R(e,y.oRequestor.lockGroup(d,y,true,true))})}this.checkSharedRequest();if(!Array.isArray(c)){throw new Error("Create is only supported for collections; '"+n+"' does not reference a collection")}o=t.publicClone(o,true)||{};g=t.merge({},o);t.setPrivateAnnotation(o,"postBody",g);t.setPrivateAnnotation(o,"transientPredicate",s);o["@$ui5.context.isTransient"]=true;if(d.startsWith("$inactive.")){o["@$ui5.context.isInactive"]=true}else{this.iActiveElements+=1;f(this.mChangeListeners,n,c,1)}if(a){c.splice(c.$created,0,o)}else{c.unshift(o)}c.$created+=1;c.$byPredicate=c.$byPredicate||{};c.$byPredicate[s]=o;if(!n){y.adjustReadRequests(0,1)}return i.then(function(t){t+=y.oRequestor.buildQueryString(y.sMetaPath,y.mQueryOptions,true);return R(t,e)})};P.prototype.deregisterChange=function(e,i){if(!this.bSharedRequest){t.removeByPath(this.mChangeListeners,e,i)}};P.prototype.drillDown=function(e,i,s,o){var u=r.resolve(e),h,l,c=false,f,p=false,g=this;function y(e,t){n[t?"info":"error"]("Failed to drill-down into "+i+", invalid segment: "+e,g.toString(),a);return undefined}function m(i,n,r){var o=f.slice(0,r).join("/"),a,u,d;if(Array.isArray(i)){return y(n,n==="0")}if(c){return y(n,true)}if(n.includes("@")){a=n.split("@")[0];if(p||a in i||i[a+"@$ui5.noData"]||g.mQueryOptions&&g.mQueryOptions.$select.includes(o.split("@")[0])){return y(n,true)}}return g.oRequestor.getModelInterface().fetchMetadata(g.sMetaPath+"/"+t.getMetaPath(o.split("@")[0])).then(function(a){var c;if(!a){return y(n)}if(a.$Type==="Edm.Stream"){u=i[n+"@odata.mediaReadLink"]||i[n+"@mediaReadLink"];d=g.oRequestor.getServiceUrl();return u||t.buildPath(d+g.sResourcePath,o)}if(!p){c=i[t.getAnnotationKey(i,".Permissions",n)];if(c===0||c==="None"){return undefined}if(!h&&!Array.isArray(e)){h=e;l=0}return h&&g.fetchLateProperty(s,h,f.slice(0,l).join("/"),f.slice(l).join("/").split("@")[0],f.slice(l,r).join("/"))||y(n)}if(a.$kind==="NavigationProperty"){return null}if(!a.$Type.startsWith("Edm.")){return{}}if("$DefaultValue"in a){return a.$Type==="Edm.String"?a.$DefaultValue:t.parseLiteral(a.$DefaultValue,a.$Type,o)}return null})}if(!i){return u}f=i.split("/");return f.reduce(function(e,i,n){return e.then(function(e){var s,r,a;if(i==="$count"){return Array.isArray(e)?e.$count:y(i)}if(e===undefined||e===null){return undefined}if(typeof e!=="object"||i==="@$ui5._"||Array.isArray(e)&&(i[0]==="$"||i==="length")){return y(i)}if(t.hasPrivateAnnotation(e,"predicate")){h=e;l=n}a=e;p=p||e["@$ui5.context.isTransient"];r=d.exec(i);if(r){if(r[1]){e=e[r[1]]}if(e){e=e.$byPredicate&&e.$byPredicate[r[2]]}}else{s=P.from$skip(i,e);if(o&&s===i&&(e[i]===undefined||e[i]===null)){e[i]={}}e=e[s]}e=e===undefined&&i[0]!=="#"&&i[0]!=="@"?m(a,i,n+1):e;if(i.includes("@")){c=true}return e})},u)};P.prototype.fetchLateProperty=function(e,i,n,s,r){var o,a,u,h,l,c,d,f=t.getMetaPath(n),p=this.fetchTypes().getResult(),g=[s],P=this;function y(e,i){var n=t.buildPath(o,i),s=p[n],r;if(!s){s=P.oRequestor.fetchType(p,n).getResult()}if(i){(s.$Key||[]).forEach(function(e){if(typeof e==="object"){e=e[Object.keys(e)[0]]}g.push(t.buildPath(i,e))})}if(e.$expand){r=Object.keys(e.$expand)[0];y(e.$expand[r],t.buildPath(i,r))}}if(!this.mLateQueryOptions){return undefined}o=t.buildPath(this.sMetaPath,f);c=t.intersectQueryOptions(t.getQueryOptionsForPath(this.mLateQueryOptions,n),[s],this.oRequestor.getModelInterface().fetchMetadata,o,{});if(!c){return undefined}y(c);a=t.buildPath(this.sResourcePath,n);d=a+this.oRequestor.buildQueryString(o,c,false,true);l=this.mPropertyRequestByPath[d];if(!l){h=a+this.oRequestor.buildQueryString(o,this.mQueryOptions,true);u=t.getPrivateAnnotation(i,"groupId");l=this.oRequestor.request("GET",h,u?this.oRequestor.lockGroup(u,this):e.getUnlockedCopy(),undefined,undefined,undefined,undefined,o,undefined,false,c).then(function(e){P.visitResponse(e,p,o,n);return e});this.mPropertyRequestByPath[d]=l}return l.then(function(e){var s=t.getPrivateAnnotation(e,"predicate"),o=t.getPrivateAnnotation(i,"predicate");if(o&&s&&o!==s){throw new Error("GET "+d+": Key predicate changed from "+o+" to "+s)}if(i["@odata.etag"]&&e["@odata.etag"]!==i["@odata.etag"]){throw new Error("GET "+d+": ETag changed")}t.updateSelected(P.mChangeListeners,n,i,e,g);return t.drillDown(i,r.split("/"))}).finally(function(){delete P.mPropertyRequestByPath[d]})};P.prototype.fetchTypes=function(){var e,t,i=this;function n(s,r){if(r&&r.$expand){Object.keys(r.$expand).forEach(function(o){var a=s;o.split("/").forEach(function(n){a+="/"+n;e.push(i.oRequestor.fetchType(t,a))});n(a,r.$expand[o])})}}if(!this.oTypePromise){e=[];t={};e.push(this.oRequestor.fetchType(t,this.sMetaPath));n(this.sMetaPath,this.mQueryOptions);this.oTypePromise=r.all(e).then(function(){return t})}return this.oTypePromise};P.prototype.getAllElements=function(e){if(e){return this.getValue(e)}return this.aElements.map(function(e){return e instanceof r?undefined:e})};P.prototype.getCreatedElements=function(e){var t=this.getValue(e);return t?t.slice(0,t.$created):[]};P.prototype.getDownloadQueryOptions=function(e){return e};P.prototype.getDownloadUrl=function(e,i){var n=this.mQueryOptions;if(e){n=t.getQueryOptionsForPath(n,e);n=t.merge({},i,n)}return this.oRequestor.getServiceUrl()+t.buildPath(this.sResourcePath,e)+this.oRequestor.buildQueryString(t.buildPath(this.sMetaPath,t.getMetaPath(e)),this.getDownloadQueryOptions(n))};P.prototype.getLateQueryOptions=function(){return this.mLateQueryOptions};P.prototype.getQueryOptions=function(){return this.mQueryOptions};P.prototype.getValue=function(e){throw new Error("Unsupported operation")};P.prototype.getOriginalResourcePath=function(e){return this.fnGetOriginalResourcePath&&this.fnGetOriginalResourcePath(e)||this.sResourcePath};P.prototype.getResourcePath=function(){return this.sResourcePath};P.prototype.hasChangeListeners=function(){return!s(this.mChangeListeners)};P.prototype.hasPendingChangesForPath=function(e,t,i){var n=this;return Object.keys(this.mPatchRequests).some(function(i){return p(i,e)&&!(t&&n.mPatchRequests[i].every(function(e){return e.$isKeepAlive()}))})||Object.keys(this.mPostRequests).some(function(t){return i&&!t?false:p(t,e)&&n.mPostRequests[t].some(function(e){return!e["@$ui5.context.isInactive"]})})};P.prototype.hasSentRequest=function(){return this.bSentRequest};P.prototype.patch=function(i,n){var s=this;this.checkSharedRequest();return this.fetchValue(e.$cached,i).then(function(e){t.updateExisting(s.mChangeListeners,i,e,n);return e})};P.prototype.refreshSingle=function(i,n,s,o,a,u){var h=this;this.checkSharedRequest();return this.fetchValue(e.$cached,n).then(function(e){var l=Object.assign({},t.getQueryOptionsForPath(h.mQueryOptions,n)),c;if(s!==undefined){o=t.getPrivateAnnotation(e[s],"predicate")}c=t.buildPath(h.sResourcePath,n,o);if(a&&h.mLateQueryOptions){t.aggregateExpandSelect(l,h.mLateQueryOptions)}delete l.$apply;delete l.$count;delete l.$filter;delete l.$orderby;delete l.$search;c+=h.oRequestor.buildQueryString(h.sMetaPath,l,false,h.bSortExpandSelect);h.bSentRequest=true;return r.all([h.oRequestor.request("GET",c,i,undefined,undefined,u),h.fetchTypes()]).then(function(t){var i=t[0];h.replaceElement(e,s,o,i,t[1],n)})})};P.prototype.refreshSingleWithRemove=function(i,n,s,o,a,u,h){var l=this;this.checkSharedRequest();return r.all([this.fetchValue(e.$cached,n),this.fetchTypes()]).then(function(e){var c=e[0],d,f,p={},g,P,y=Object.assign({},t.getQueryOptionsForPath(l.mQueryOptions,n)),m,v=t.buildPath(l.sResourcePath,n),R=[],$=e[1];if(s!==undefined){d=c[s];o=t.getPrivateAnnotation(d,"predicate")}else{d=c.$byPredicate[o]}P=t.getKeyFilter(d,l.sMetaPath,$);f=(y.$filter?"("+y.$filter+") and ":"")+P;delete y.$count;delete y.$orderby;l.bSentRequest=true;if(a){if(l.mLateQueryOptions){t.aggregateExpandSelect(y,l.mLateQueryOptions)}p=Object.assign({},y);p.$filter=f;y.$filter=P;delete y.$search;m=v+l.oRequestor.buildQueryString(l.sMetaPath,y,false,l.bSortExpandSelect);R.push(l.oRequestor.request("GET",m,i,undefined,undefined,u));if(s!==undefined&&(P!==f||p.$search)){delete p.$select;delete p.$expand;p.$count=true;p.$top=0;g=v+l.oRequestor.buildQueryString(l.sMetaPath,p);R.push(l.oRequestor.request("GET",g,i.getUnlockedCopy()))}}else{y.$filter=f;m=v+l.oRequestor.buildQueryString(l.sMetaPath,y,false,l.bSortExpandSelect);R.push(l.oRequestor.request("GET",m,i,undefined,undefined,u))}return r.all(R).then(function(e){var t=e[0].value,i=e[1]&&e[1]["@odata.count"]==="0";if(t.length>1){throw new Error("Unexpected server response, more than one entity returned.")}else if(t.length===0){l.removeElement(c,s,o,n);l.oRequestor.getModelInterface().reportStateMessages(l.sResourcePath,{},[n+o]);h(false)}else if(i){l.removeElement(c,s,o,n);l.replaceElement(c,undefined,o,t[0],$,n);h(true)}else{l.replaceElement(c,s,o,t[0],$,n)}})})};P.prototype.registerChange=function(e,i){if(!this.bSharedRequest){t.addByPath(this.mChangeListeners,e,i)}};P.prototype.removeElement=function(e,i,n,s){var r,o;r=e.$byPredicate[n];if(i!==undefined){i=P.getElementIndex(e,n,i);e.splice(i,1);f(this.mChangeListeners,s,e,-1)}delete e.$byPredicate[n];o=t.getPrivateAnnotation(r,"transientPredicate");if(o){e.$created-=1;if(!s){this.iActiveElements-=1}delete e.$byPredicate[o]}if(!s&&i!==undefined){if(!o){this.iLimit-=1}this.adjustReadRequests(i,-1)}return i};P.prototype.removeMessages=function(){if(this.sReportedMessagesPath){this.oRequestor.getModelInterface().reportStateMessages(this.sReportedMessagesPath,{});this.sReportedMessagesPath=undefined}};P.prototype.removePendingRequest=function(){if(this.oPendingRequestsPromise){this.oPendingRequestsPromise.$count-=1;if(!this.oPendingRequestsPromise.$count){this.oPendingRequestsPromise.$resolve();this.oPendingRequestsPromise=null}}};P.prototype.replaceElement=function(e,i,n,s,r,o){var a,u;if(i===undefined){e.$byPredicate[n]=s}else{i=P.getElementIndex(e,n,i);a=e[i];e[i]=e.$byPredicate[n]=s;u=t.getPrivateAnnotation(a,"transientPredicate");if(u){s["@$ui5.context.isTransient"]=false;e.$byPredicate[u]=s;t.setPrivateAnnotation(s,"transientPredicate",u)}}this.visitResponse(s,r,t.getMetaPath(t.buildPath(this.sMetaPath,o)),o+n)};P.prototype.requestCount=function(e){var t,i,n,s=this;if(this.mQueryOptions&&this.mQueryOptions.$count){i=Object.assign({},this.mQueryOptions);delete i.$expand;delete i.$orderby;delete i.$select;t=this.getFilterExcludingCreated();if(t){i.$filter=i.$filter?"("+i.$filter+") and "+t:t}i.$top=0;n=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,i);return this.oRequestor.request("GET",n,e.getUnlockedCopy()).catch(function(t){if(t.cause&&t.cause.status===404){return s.oRequestor.request("GET",n,e.getUnlockedCopy())}throw t}).then(function(e){var t=parseInt(e["@odata.count"])+s.iActiveElements;g(s.mChangeListeners,"",s.aElements,t);s.iLimit=t})}};P.prototype.resetChangesForPath=function(e){var i=this;Object.keys(this.mPatchRequests).forEach(function(t){var n,s;if(p(t,e)){n=i.mPatchRequests[t];for(s=n.length-1;s>=0;s-=1){i.oRequestor.removePatch(n[s])}delete i.mPatchRequests[t]}});Object.keys(this.mPostRequests).forEach(function(n){var s,r,o;if(p(n,e)){s=i.mPostRequests[n];for(o=s.length-1;o>=0;o-=1){r=t.getPrivateAnnotation(s[o],"transient");if(!r.startsWith("$inactive.")){i.oRequestor.removePost(r,s[o])}}}})};P.prototype.setActive=function(e){if(e){this.iActiveUsages+=1;this.iInactiveSince=Infinity}else{this.iActiveUsages-=1;if(!this.iActiveUsages){this.iInactiveSince=Date.now()}this.mChangeListeners={}}};P.prototype.setLateQueryOptions=function(e){if(e){this.mLateQueryOptions={$select:e.$select,$expand:e.$expand}}else{this.mLateQueryOptions=null}};P.prototype.setProperty=function(i,n,s){var r=this;this.checkSharedRequest();return this.fetchValue(e.$cached,s,null,null,true).then(function(e){t.updateAll(r.mChangeListeners,s,e,P.makeUpdateData(i.split("/"),n))})};P.prototype.setQueryOptions=function(e,t){this.checkSharedRequest();if(this.bSentRequest&&!t){throw new Error("Cannot set query options: Cache has already sent a request")}this.mQueryOptions=e;this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,e,false,this.bSortExpandSelect)};P.prototype.setResourcePath=function(e){this.checkSharedRequest();this.sResourcePath=e;this.sMetaPath=t.getMetaPath("/"+e);this.oTypePromise=undefined;this.mLateQueryOptions=null;this.mPropertyRequestByPath={}};P.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.sQueryString};P.prototype.update=function(i,s,o,u,h,l,c,d,p,g){var y,m=s.split("/"),v,R=this;this.checkSharedRequest();try{y=this.fetchValue(e.$cached,l)}catch(e){if(!e.$cached||this.oPromise!==null){throw e}y=this.oPromise=r.resolve({"@odata.etag":"*"})}return y.then(function(e){var y=t.buildPath(l,s),$=i.getGroupId(),E,q,b,S,A,w,O=P.makeUpdateData(m,o);function M(){t.removeByPath(R.mPatchRequests,y,q);t.updateExisting(R.mChangeListeners,l,e,P.makeUpdateData(m,E))}function k(i,n){var s={"If-Match":e},o;function a(){o=R.oRequestor.lockGroup($,R,true);p()}if(d){s.Prefer="return=minimal"}q=R.oRequestor.request("PATCH",h,i,s,O,a,M,undefined,t.buildPath(R.getOriginalResourcePath(e),l),n);q.$isKeepAlive=g;t.addByPath(R.mPatchRequests,y,q);return r.all([q,R.fetchTypes()]).then(function(i){var n=i[0];t.removeByPath(R.mPatchRequests,y,q);if(!d){R.visitResponse(n,i[1],t.getMetaPath(t.buildPath(R.sMetaPath,l)),l)}t.updateExisting(R.mChangeListeners,l,e,d?{"@odata.etag":n["@odata.etag"]}:n)},function(i){var n=$;if(!u){M();throw i}t.removeByPath(R.mPatchRequests,y,q);if(i.canceled){throw i}u(i);switch(R.oRequestor.getGroupSubmitMode($)){case"API":break;case"Auto":if(!R.oRequestor.hasChanges($,e)){n="$parked."+$}break;default:throw i}o.unlock();o=undefined;return k(R.oRequestor.lockGroup(n,R,true,true),true)}).finally(function(){if(o){o.unlock()}})}if(!e){throw new Error("Cannot update '"+s+"': '"+l+"' does not exist")}A=t.getPrivateAnnotation(e,"transient");if(A){if(typeof A!=="string"){throw new Error("No 'update' allowed while waiting for server response")}if(A.startsWith("$parked.")||A.startsWith("$inactive.")){S=A;A=A.slice(A.indexOf(".")+1)}if(A!==$){throw new Error("The entity will be created via group '"+A+"'. Cannot patch via group '"+$+"'")}}E=t.drillDown(e,m);b=t.getPrivateAnnotation(e,"postBody");if(b){t.updateAll({},l,b,O);if(e["@$ui5.context.isInactive"]){O["@$ui5.context.isInactive"]=false;R.iActiveElements+=1;f(R.mChangeListeners,"",R.aElements,1)}}t.updateAll(R.mChangeListeners,l,e,O);if(c){v=c.split("/");c=t.buildPath(l,c);w=R.getValue(c);if(w===undefined){n.debug("Missing value for unit of measure "+c+" when updating "+y,R.toString(),a)}else{t.merge(A?b:O,P.makeUpdateData(v,w))}}if(A){if(S){t.setPrivateAnnotation(e,"transient",A);R.oRequestor.relocate(S,b,A)}i.unlock();return Promise.resolve()}R.oRequestor.relocateAll("$parked."+$,$,e);h+=R.oRequestor.buildQueryString(R.sMetaPath,R.mQueryOptions,true);return k(i)})};P.prototype.visitResponse=function(e,i,n,s,r,o){var a,h=false,c={},d=this.oRequestor.getServiceUrl()+this.sResourcePath,f=this;function p(e,i,n){h=true;if(e&&e.length){c[i]=e;e.forEach(function(e){if(e.longtextUrl){e.longtextUrl=t.makeAbsolute(e.longtextUrl,n)}})}}function P(e,i){return i?t.makeAbsolute(i,e):e}function y(e,i,n,s){var r={},u,h,l,c;for(c=0;c<e.length;c+=1){h=e[c];u=n===""?o+c:c;if(h&&typeof h==="object"){m(h,i,n,s,u);l=t.getPrivateAnnotation(h,"predicate");if(!n){a.push(l||u.toString())}if(l){r[l]=h;e.$byPredicate=r}}}}function m(e,n,o,h,c){var d,v,R=i[n],$=R&&R[l]&&R[l].$Path,E;h=P(h,e["@odata.context"]);v=f.calculateKeyPredicate(e,i,n);if(c!==undefined){o=t.buildPath(o,v||c)}else if(!r&&v){d=u.exec(o);if(d){o=o.slice(0,-d[0].length)+v}}if(s&&!a){a=[o]}if($){E=t.drillDown(e,$.split("/"));if(E!==undefined){p(E,o,h)}}Object.keys(e).forEach(function(i){var s,r=n+"/"+i,a=e[i],u=t.buildPath(o,i);if(i.endsWith("@odata.mediaReadLink")||i.endsWith("@mediaReadLink")){e[i]=t.makeAbsolute(a,h)}if(i===$||i.includes("@")){return}if(Array.isArray(a)){a.$created=0;a.$count=undefined;s=e[i+"@odata.count"];if(s){g({},"",a,s)}else if(!e[i+"@odata.nextLink"]){g({},"",a,a.length)}y(a,r,u,P(h,e[i+"@odata.context"]))}else if(a&&typeof a==="object"){m(a,r,u,h)}})}if(o!==undefined){a=[];y(e.value,n||this.sMetaPath,"",P(d,e["@odata.context"]))}else if(e&&typeof e==="object"){m(e,n||this.sMetaPath,s||"",d)}if(h){this.sReportedMessagesPath=this.getOriginalResourcePath(e);this.oRequestor.getModelInterface().reportStateMessages(this.sReportedMessagesPath,c,a)}};function y(e,t,i,n,s,r){P.call(this,e,t,i,n,function(){return s},r);this.iActiveElements=0;this.oBackup=null;this.sContext=undefined;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.aElements.$tail=undefined;this.iLimit=Infinity;this.aReadRequests=[];this.bServerDrivenPaging=false;this.oSyncPromiseAll=undefined}y.prototype=Object.create(P.prototype);y.prototype.addKeptElement=function(e){this.aElements.$byPredicate[t.getPrivateAnnotation(e,"predicate")]=e};y.prototype.adjustReadRequests=function(e,t){this.aReadRequests.forEach(function(i){if(i.iStart>=e){i.iStart+=t;i.iEnd+=t}})};y.prototype.createEmptyElement=function(e){var i={};t.setPrivateAnnotation(i,"predicate",e);this.aElements.$byPredicate[e]=i;return i};y.prototype.doReplaceWith=function(e,t){this.aElements[e]=t;this.addKeptElement(t)};y.prototype.fetchValue=function(t,i,n,s,o){var a,u=i.split("/")[0],h,l=this;t.unlock();if(this.aElements.$byPredicate[u]){h=r.resolve()}else if((t===e.$cached||u!=="$count")&&this.aElements[u]!==undefined){h=r.resolve(this.aElements[u])}else{if(!this.oSyncPromiseAll){a=this.aElements.$tail?this.aElements.concat(this.aElements.$tail):this.aElements;this.oSyncPromiseAll=r.all(a)}h=this.oSyncPromiseAll}return h.then(function(){l.registerChange(i,s);return l.drillDown(l.aElements,i,t,o)})};y.prototype.fill=function(e,t,i){var n,s=Math.max(this.aElements.length,1024);if(i>s){if(this.aElements.$tail&&e){throw new Error("Cannot fill from "+t+" to "+i+", $tail already in use, # of elements is "+this.aElements.length)}this.aElements.$tail=e;i=this.aElements.length}for(n=t;n<i;n+=1){this.aElements[n]=e}this.oSyncPromiseAll=undefined};y.prototype.getFilterExcludingCreated=function(){var e,i,n=[],s,r;for(r=0;r<this.aElements.$created;r+=1){e=this.aElements[r];if(!e["@$ui5.context.isTransient"]){s=s||this.fetchTypes().getResult();i=t.getKeyFilter(e,this.sMetaPath,s);if(i){n.push(i)}}}return n.length?"not ("+n.sort().join(" or ")+")":undefined};y.prototype.getQueryString=function(){var e=this.getFilterExcludingCreated(),i=Object.assign({},this.mQueryOptions),n=i.$filter,s=this.sQueryString;if(e){if(n){i.$filter="("+n+") and "+e;s=this.oRequestor.buildQueryString(this.sMetaPath,i,false,this.bSortExpandSelect)}else{s+=(s?"&":"?")+"$filter="+t.encode(e,false)}}return s};y.prototype.getResourcePathWithQuery=function(e,t){var i=this.aElements.$created,n=this.getQueryString(),s=n?"&":"?",r=t-e,o=this.sResourcePath+n;if(e<i){throw new Error("Must not request created element")}e-=i;if(e>0||r<Infinity){o+=s+"$skip="+e}if(r<Infinity){o+="&$top="+r}return o};y.prototype.getValue=function(t){var i;if(!t){return this.aElements}i=this.fetchValue(e.$cached,t);if(i.isFulfilled()){return i.getResult()}i.caught()};y.prototype.handleCount=function(e,t,i,n,s,r){var o=s["@odata.count"],a=this.aElements.$created,u,h=-1,l=this.aElements.$count,c,d=s.value.length,f;n-=r;d-=r;if(o){u=parseInt(o)-r;if(r===t||i===a&&d===u){this.iLimit=h=u}else{c=this.requestCount(this.oRequestor.getUnlockedAutoCopy(e))}}if(s["@odata.nextLink"]){this.bServerDrivenPaging=true;if(n<this.aElements.length){for(f=i+d;f<n;f+=1){delete this.aElements[f]}}else{this.aElements.length=i+d}}else if(d<n-i){if(h===-1){h=l&&l-this.iActiveElements}h=Math.min(h!==undefined?h:Infinity,i-a+d);this.aElements.length=a+h;this.iLimit=h;if(!o&&h>0&&!this.aElements[h-1]){h=undefined}}if(h!==-1){g(this.mChangeListeners,"",this.aElements,h!==undefined?h+this.iActiveElements:undefined)}return c};y.prototype.handleResponse=function(e,i,n){var s,r=this.aElements,o=r.$created,a,u=0,h,l=e.value.length,c;this.sContext=e["@odata.context"];this.visitResponse(e,n,undefined,undefined,undefined,i);for(c=0;c<l;c+=1){s=e.value[c];h=t.getPrivateAnnotation(s,"predicate");if(h){a=r.$byPredicate[h];if(a){if(!a["@odata.etag"]||s["@odata.etag"]===a["@odata.etag"]){if(o&&r.lastIndexOf(a,o-1)>=0){u+=1;r[i+l-u]=undefined;continue}t.updateNonExisting(a,s);s=a}else if(this.hasPendingChangesForPath(h)){throw new Error("Modified on client and on server: "+this.sResourcePath+h)}}r.$byPredicate[h]=s}r[i+c-u]=s}return u};y.prototype.read=function(e,i,n,s,a){var u=0,h,l,c,d=this.oPendingRequestsPromise||this.aElements.$tail,f,p=0,g,P=this;if(e<0){throw new Error("Illegal index "+e+", must be >= 0")}if(i<0){throw new Error("Illegal length "+i+", must be >= 0")}if(d){return d.then(function(){return P.read(e,i,n,s,a)})}for(g=0;g<this.aElements.$created;g+=1){h=this.aElements[g];if(t.getPrivateAnnotation(h,"transient")===s.getGroupId()){p+=1}if(P.oBackup&&!h["@$ui5.context.isTransient"]){u+=1}}f=o._getReadIntervals(this.aElements,e,i,this.bServerDrivenPaging?0:Math.max(n,p,u),this.aElements.$created+this.iLimit);if(p&&(f.length>1||f.length&&f[0].start>this.aElements.$created)){s.unlock();return this.oRequestor.waitForBatchResponseReceived(s.getGroupId()).then(function(){return P.read(e,i,n,P.oRequestor.getUnlockedAutoCopy(s),a)})}f.forEach(function(e){P.requestElements(e.start,e.end,s.getUnlockedCopy(),p,a);a=undefined});s.unlock();c=e+i+n;l=this.aElements.slice(e,c);if(this.aElements.$tail&&c>this.aElements.length){l.push(this.aElements.$tail)}return r.all(l).then(function(){var t=P.aElements.slice(e,e+i);t.$count=P.aElements.$count;return{"@odata.context":P.sContext,value:t}})};y.prototype.refreshKeptElements=function(e,i){var n=this,s=Object.keys(this.aElements.$byPredicate).filter(a).sort(),r;function o(){var e,i=t.merge({},n.mQueryOptions);if(n.mLateQueryOptions){t.aggregateExpandSelect(i,n.mLateQueryOptions)}delete i.$count;delete i.$orderby;delete i.$search;e=s.map(function(e){return t.getKeyFilter(n.aElements.$byPredicate[e],n.sMetaPath,r)});i.$filter=e.join(" or ");if(e.length>1){i.$top=e.length}return n.sResourcePath+n.oRequestor.buildQueryString(n.sMetaPath,i,false,true)}function a(e){var i=n.aElements.$byPredicate[e];return t.getPrivateAnnotation(i,"predicate")===e&&!n.hasPendingChangesForPath(e)}if(s.length===0){return undefined}r=this.fetchTypes().getResult();return this.oRequestor.request("GET",o(),e).then(function(e){var o;n.visitResponse(e,r,undefined,undefined,undefined,0);o=e.value.$byPredicate||{};s.forEach(function(e){var s,r;if(e in o){t.updateAll(n.mChangeListeners,e,n.aElements.$byPredicate[e],o[e])}else{s=n.aElements.$byPredicate[e];if(t.getPrivateAnnotation(s,"transientPredicate")){r=n.removeElement(n.aElements,-1,e,"")}else{delete n.aElements.$byPredicate[e]}i(e,r)}})})};y.prototype.requestElements=function(e,t,i,n,s){var o,a={iEnd:t,iStart:e},u=this;this.aReadRequests.push(a);this.bSentRequest=true;o=r.all([this.oRequestor.request("GET",this.getResourcePathWithQuery(e,t),i,undefined,undefined,s),this.fetchTypes()]).then(function(e){var t;if(u.aElements.$tail===o){u.aElements.$tail=undefined}t=u.handleResponse(e[0],a.iStart,e[1]);return u.handleCount(i,n,a.iStart,a.iEnd,e[0],t)}).catch(function(e){u.fill(undefined,a.iStart,a.iEnd);throw e}).finally(function(){u.aReadRequests.splice(u.aReadRequests.indexOf(a),1)});this.fill(o,e,t)};y.prototype.requestSideEffects=function(e,i,n,s,o){var a,u=-1,h,l,c={},d,f,p=this.fetchTypes().getResult(),g=this;this.checkSharedRequest();if(this.oPendingRequestsPromise){return this.oPendingRequestsPromise.then(function(){return g.requestSideEffects(e,i,n,s,o)})}l=t.intersectQueryOptions(Object.assign({},this.mQueryOptions,this.mLateQueryOptions),i,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath,n,"",true);if(!l){return r.resolve()}if(o){a=[this.aElements.$byPredicate[s[0]]]}else{s.forEach(function(e){c[e]=true});a=this.aElements.filter(function(e,i){var n;if(!e){return false}if(t.hasPrivateAnnotation(e,"transient")){u=i;return false}n=t.getPrivateAnnotation(e,"predicate");if(c[n]||t.hasPrivateAnnotation(e,"transientPredicate")){u=i;delete c[n];return true}delete g.aElements[i];delete g.aElements.$byPredicate[n];return false});this.aElements.length=u+1;if(!a.length){return r.resolve()}Object.keys(c).forEach(function(e){a.push(g.aElements.$byPredicate[e])})}l.$filter=a.map(function(e){return t.getKeyFilter(e,g.sMetaPath,p)}).join(" or ");if(a.length>1){l.$top=a.length}t.selectKeyProperties(l,p[this.sMetaPath]);delete l.$count;delete l.$orderby;delete l.$search;h=t.extractMergeableQueryOptions(l);d=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,l,false,true);return this.oRequestor.request("GET",d,e,undefined,undefined,undefined,undefined,this.sMetaPath,undefined,false,h,this,function(e){if(arguments.length){i=i.concat(e)}else{f=true;return i}}).then(function(e){var n,s,r,o;function u(e){e=e.slice(s.length+1);return!i.some(function(i){return t.getRelativePath(e,i)!==undefined})}if(f){return}if(e.value.length!==a.length){throw new Error("Expected "+a.length+" row(s), but instead saw "+e.value.length)}g.visitResponse(e,p,undefined,"",false,NaN);for(r=0,o=e.value.length;r<o;r+=1){n=e.value[r];s=t.getPrivateAnnotation(n,"predicate");t.updateAll(g.mChangeListeners,s,g.aElements.$byPredicate[s],n,u)}})};y.prototype.reset=function(e,i){var n=this.aElements.$byPredicate,s=this.mChangeListeners,r=0,o,a,u,h=this;if(i){this.oBackup={iActiveElements:this.iActiveElements,mChangeListeners:this.mChangeListeners,sContext:this.sContext,aElements:this.aElements.slice(),$byPredicate:n,$count:this.aElements.$count,$created:this.aElements.$created,iLimit:this.iLimit}}for(u=0;u<this.aElements.$created;u+=1){o=this.aElements[u];a=t.getPrivateAnnotation(o,"transient");if(i?"@$ui5.context.isInactive"in o||a&&a!==i:a){e.push(t.getPrivateAnnotation(o,"predicate")||t.getPrivateAnnotation(o,"transientPredicate"));this.aElements[r]=o;r+=1}else{this.iActiveElements-=1}}this.mChangeListeners={};this.sContext=undefined;this.aElements.length=this.aElements.$created=r;this.aElements.$byPredicate={};this.aElements.$count=undefined;this.iLimit=Infinity;Object.keys(s).forEach(function(t){if(e.includes(t.split("/")[0])){h.mChangeListeners[t]=s[t]}});e.forEach(function(e){h.aElements.$byPredicate[e]=n[e]})};y.prototype.restore=function(e){if(e){this.iActiveElements=this.oBackup.iActiveElements;this.mChangeListeners=this.oBackup.mChangeListeners;this.sContext=this.oBackup.sContext;this.aElements.length=this.oBackup.aElements.length;this.oBackup.aElements.forEach(function(e,t){this[t]=e},this.aElements);this.aElements.$byPredicate=this.oBackup.$byPredicate;this.aElements.$count=this.oBackup.$count;this.aElements.$created=this.oBackup.$created;this.iLimit=this.oBackup.iLimit}this.oBackup=null};function m(e,t,i){P.call(this,e,t,i);this.oPromise=null}m.prototype=Object.create(P.prototype);m.prototype._delete=function(){throw new Error("Unsupported")};m.prototype.create=function(){throw new Error("Unsupported")};m.prototype.fetchValue=function(e,t,i,n,s){var o=this;if(s){throw new Error("Unsupported argument: bCreateOnDemand")}if(this.oPromise){e.unlock()}else{this.bSentRequest=true;this.oPromise=r.resolve(this.oRequestor.request("GET",this.sResourcePath+this.sQueryString,e,undefined,undefined,i,undefined,this.sMetaPath))}return this.oPromise.then(function(e){o.registerChange("",n);return e&&typeof e==="object"?e.value:e})};m.prototype.update=function(){throw new Error("Unsupported")};function v(e,t,i,n,s,o,a,u,h){P.call(this,e,t,i,n,o,s);this.sMetaPath=u||this.sMetaPath;this.bPost=a;this.bPosting=false;if(h){this.oPromise=r.resolve({})}else{this.oPromise=null}}v.prototype=Object.create(P.prototype);v.prototype.fetchValue=function(e,t,i,n,s){var o=this.sResourcePath+this.sQueryString,a=this;if(this.oPromise){e.unlock()}else{if(this.bPost){throw new Error("Cannot fetch a value before the POST request")}this.oPromise=r.all([this.oRequestor.request("GET",o,e,undefined,undefined,i,undefined,this.sMetaPath),this.fetchTypes()]).then(function(e){a.visitResponse(e[0],e[1]);return e[0]});this.bSentRequest=true}return this.oPromise.then(function(i){if(i&&i["$ui5.deleted"]){throw new Error("Cannot read a deleted entity")}a.registerChange(t,n);return a.drillDown(i,t,e,s)})};v.prototype.getValue=function(t){var i;if(this.oPromise&&this.oPromise.isFulfilled()){i=this.drillDown(this.oPromise.getResult(),t,e.$cached);if(i.isFulfilled()){return i.getResult()}i.caught()}};v.prototype.post=function(e,t,i,n,s){var o,a=i?{"If-Match":n&&"@odata.etag"in i?"*":i}:{},u="POST",h=this;function l(e){h.bPosting=true;return r.all([h.oRequestor.request(u,h.sResourcePath+h.sQueryString,e,a,t),h.fetchTypes()]).then(function(e){h.visitResponse(e[0],e[1]);h.bPosting=false;return e[0]},function(t){h.bPosting=false;if(s&&t.strictHandlingFailed){return s(t).then(function(t){var i;if(t){delete a["Prefer"];return l(e.getUnlockedCopy())}i=Error("Action canceled due to strict handling");i.canceled=true;throw i})}throw t})}this.checkSharedRequest();if(!this.bPost){throw new Error("POST request not allowed")}if(this.bPosting){throw new Error("Parallel POST requests not allowed")}if(i){o=e.getGroupId();this.oRequestor.relocateAll("$parked."+o,o,i)}if(t){u=t["X-HTTP-Method"]||u;delete t["X-HTTP-Method"];if(this.oRequestor.isActionBodyOptional()&&!Object.keys(t).length){t=undefined}}this.bSentRequest=true;if(s){a["Prefer"]="handling=strict"}this.oPromise=l(e);return this.oPromise};v.prototype.requestSideEffects=function(i,n,s,o){var a,u,h,l,c=this;this.checkSharedRequest();u=this.oPromise&&t.intersectQueryOptions(Object.assign({},this.mQueryOptions,this.mLateQueryOptions),n,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath,s);if(!u){return r.resolve()}if(this.oPromise.isRejected()){throw new Error(this+": Cannot call requestSideEffects, cache is broken: "+this.oPromise.getResult().message)}a=t.extractMergeableQueryOptions(u);o=(o||this.sResourcePath)+this.oRequestor.buildQueryString(this.sMetaPath,u,false,true);h=r.all([this.oRequestor.request("GET",o,i,undefined,undefined,undefined,undefined,this.sMetaPath,undefined,false,a,this,function(e){if(arguments.length){n=n.concat(e)}else{l=true;return n}}),this.fetchTypes(),this.fetchValue(e.$cached,"")]).then(function(e){return e}).then(function(e){var i=e[0],s=e[2];if(l){return}t.setPrivateAnnotation(i,"predicate",t.getPrivateAnnotation(s,"predicate"));c.visitResponse(i,e[1]);t.updateAll(c.mChangeListeners,"",s,i,function(e){return!n.some(function(i){return t.getRelativePath(e,i)!==undefined})})});return h};v.prototype.resetProperty=function(e){var t=this.oPromise.getResult();if(t){e.split("/").some(function(e){delete t["@odata.etag"];if(typeof t[e]==="object"){t=t[e];return false}delete t[e];return true})}};function R(e,t,i){var n=t.split("/"),s=n[0],r=s+JSON.stringify(i),o=e.$mSingletonCacheByPath;m.call(this,e,t,{});if(!o){o=e.$mSingletonCacheByPath={}}this.oSingleton=o[r];if(!this.oSingleton){this.oSingleton=o[r]=new v(e,s,i,undefined,undefined,undefined,undefined,undefined,true)}this.sRelativePath=t.split(s+"/")[1]}R.prototype=Object.create(m.prototype);R.prototype.fetchValue=function(e,i,n,s,r){var o=this.oSingleton.sResourcePath+"/"+this.sRelativePath,a,u=this.oMetadataPromise||this.oRequestor.getModelInterface().fetchMetadata("/"+t.getMetaPath(o)),h=this;return u.then(function(){if(!h.oMetadataPromise){a=h.oSingleton.getLateQueryOptions()||{};t.aggregateExpandSelect(a,t.wrapChildQueryOptions("/"+h.oSingleton.sResourcePath,h.sRelativePath,{},h.oRequestor.getModelInterface().fetchMetadata));h.oSingleton.setLateQueryOptions(a)}h.oMetadataPromise=u;return h.oSingleton.fetchValue(e,h.sRelativePath,n,s,r)})};R.prototype.reset=function(){this.oSingleton.resetProperty(this.sRelativePath)};P.create=function(e,i,n,s,r,o){var a,u,h,l,c;if(o){h=i+e.buildQueryString(t.getMetaPath("/"+i),n,false,s);c=e.$mSharedCollectionCacheByPath;if(!c){c=e.$mSharedCollectionCacheByPath={}}l=c[h];if(l){l.setActive(true)}else{u=Object.keys(c);a=u.length;if(a>100){u.filter(function(e){return!c[e].iActiveUsages}).sort(function(e,t){return c[e].iInactiveSince-c[t].iInactiveSince}).every(function(e){delete c[e];a-=1;return a>100})}l=c[h]=new y(e,i,n,s,r,o)}return l}return new y(e,i,n,s,r)};P.createProperty=function(e,t,i){if(t.includes("(")||t.endsWith("/$count")){return new m(e,t,i)}return new R(e,t,i)};P.createSingle=function(e,t,i,n,s,r,o,a){return new v(e,t,i,n,s,r,o,a)};P.from$skip=function(e,t){return c.test(e)?(t.$created||0)+Number(e):e};P.getElementIndex=function(e,i,n){var s=e[n];if(!s||t.getPrivateAnnotation(s,"predicate")!==i){n=e.indexOf(e.$byPredicate[i])}return n};P.makeUpdateData=function(e,t){return e.reduceRight(function(e,t){var i={};i[t]=e;return i},t)};return P},false);