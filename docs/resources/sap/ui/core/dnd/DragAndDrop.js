/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../library","sap/ui/Device","../UIArea","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/control"],function(t,e,r,n){"use strict";var i=t.dnd.RelativeDropPosition;var o={},a=null,f=null,g=null,u=[],s=[],l=null,d,c,p,D,h={},v;function m(t,e){if(!t){return}if(t.addStyleClass){t.addStyleClass(e)}else{t.$().addClass(e)}}function w(t,e){if(!t){return}if(t.removeStyleClass){t.removeStyleClass(e)}else{t.$().removeClass(e)}}function C(t,e){var r=n(t.target).control(0,true);if(!r){return}var i=n.Event(null,t);i.type=e;r.getUIArea()._handleEvent(i)}function b(t){return!t.disabled&&/^(input|textarea)$/.test(t.localName)}function E(t,e){if(!t||!t.getDragGhost){return}var r=t.getDragGhost();if(!r){return}if(!c){c=n('<div class="sapUiDnDGhostContainer"></div>');n(document.body).append(c)}c.append(r);window.setTimeout(function(){c.empty()},0);var i=e.originalEvent;i.dataTransfer.setDragImage(r,i.offsetX,i.offsetY)}function y(t){var e={},r,n=t.originalEvent.dataTransfer,i=function(t,e){n.setData(t,e)};return{setData:function(t,r){r=""+r;e[t]=r;i(t,r)},getData:function(t){return e[t]},setTextData:function(t){t=""+t;e["text/plain"]=t;e["text"]=t;i("text/plain",t);i("text",t)},getTextData:function(){return e["text/plain"]},setComplexData:function(t,r){e[t]=r},getComplexData:function(t){return e[t]},getIndicator:function(){return d&&d[0]},setIndicatorConfig:function(t){r=t},getIndicatorConfig:function(t){return r},getDragControl:function(){return a},getDropControl:function(){return g},setDropControl:function(t){g=t},getDropInfo:function(){return s[0]||null},getDropPosition:function(){return p}}}function S(t){a=f=g=l=null;p="";u=[];s=[]}function O(){if(d){return d}d=n("<div class='sapUiDnDIndicator'></div>");n(sap.ui.getCore().getStaticAreaRef()).append(d);return d}function A(){if(d){d.removeAttr("style");d.hide();h={}}}function x(t,e,r,n){if(!e){return}var o=t.dragSession&&t.dragSession.getIndicatorConfig(),a=e.getBoundingClientRect(),f=window.pageYOffset,g=window.pageXOffset,u=O(),s,l={},d={top:a.top+f,bottom:a.bottom+f,left:a.left+g,right:a.right+g,width:a.width,height:a.height};if(!r||r=="On"){s=i.On;n=""}else if(n=="Horizontal"){var c=t.pageX-d.left;l.height=d.height;l.top=d.top;if(r=="Between"){l.width="";if(c<d.width*.5){s=i.Before;l.left=d.left}else{s=i.After;l.left=d.right}}else if(r=="OnOrBetween"){if(c<d.width*.25){s=i.Before;l.left=d.left;l.width=""}else if(c>d.width*.75){s=i.After;l.left=d.right;l.width=""}else{s=i.On}}if(s!=i.On&&sap.ui.getCore().getConfiguration().getRTL()){s=s==i.After?i.Before:i.After}}else{var p=t.pageY-d.top;l.width=d.width;l.left=d.left;if(r=="Between"){l.height="";if(p<d.height*.5){s=i.Before;l.top=d.top}else{s=i.After;l.top=d.bottom}}else if(r=="OnOrBetween"){if(p<d.height*.25){s=i.Before;l.top=d.top;l.height=""}else if(p>d.height*.75){s=i.After;l.top=d.bottom;l.height=""}else{s=i.On}}}if(o&&o.display=="none"){return s}if(s==i.On){l.top=d.top;l.left=d.left;l.width=d.width;l.height=d.height;r=s}else{r="Between"}if(h.top!=l.top||h.left!=l.left||h.width!=l.width||h.height!=l.height){u.attr("data-drop-layout",n);u.attr("data-drop-position",r);u.css(Object.assign(l,o));u.show();h=l}return s}function T(t){var e=t.getParent(),r=t.getDragDropConfig?t.getDragDropConfig():[],n=e&&e.getDragDropConfig?e.getDragDropConfig():[];return r.concat(n)}function I(t){var e=T(t);return e.filter(function(e){return e.isDraggable(t)})}function B(t,e,r){var n=T(t);e=e||[];return n.filter(function(t){return!t.isA("sap.ui.core.dnd.IDragInfo")}).concat(e).filter(function(n){if(!n.isDroppable(t,r)){return false}var i=n.getGroupName();if(!i){return true}return e.some(function(t){return t.getGroupName()==i})})}function N(t,e){t.preventDefault();if(a){var r=e.getDropEffect().toLowerCase();t.originalEvent.dataTransfer.dropEffect=r}}function U(t,e,r){var n=e.getTargetAggregation();if(!n){return x(t,r.getDomRef())}var i;if(t.getMark("DragWithin")==n){i=r.getDomRefForSetting(n)}i=i||r.getDomRef();return x(t,i,e.getDropPosition(true),e.getDropLayout(true))}o.preprocessEvent=function(t){if(l&&t.type.indexOf("dr")==0){t.dragSession=l}var e="onbefore"+t.type;if(o[e]){o[e](t)}};o.postprocessEvent=function(t){var e="onafter"+t.type;if(o[e]){o[e](t)}};o.onbeforemousedown=function(t){if(e.browser.firefox&&b(t.target)){v=n(t.target).closest("[data-sap-ui-draggable=true]").prop("draggable",false)[0]}};o.onbeforemouseup=function(t){if(v){v.draggable=true;v=null}};o.onbeforedragstart=function(t){if(!t.target.draggable){return}if(b(document.activeElement)){t.target.getAttribute("data-sap-ui-draggable")&&t.preventDefault();return}a=n(t.target).control(0,true);if(!a){return}u=I(a);if(!u.length){return}if(!e.system.desktop&&!t.originalEvent.dataTransfer.getData("text")){t.originalEvent.dataTransfer.setData("text"," ")}t.dragSession=l=y(t)};o.onafterdragstart=function(t){if(!u.length||t.isDefaultPrevented()){S();return}u=t.isMarked("NonDraggable")?[]:u.filter(function(e){return e.fireDragStart(t)});if(!u.length){t.preventDefault();S();return}E(a,t);m(a,"sapUiDnDDragging");if(n(t.target).closest(".sapUiScrollDelegate")[0]){n("html").addClass("sapUiDnDNoScrolling")}};o.onbeforedragenter=function(t){var e=n(t.target).control(0,true);if(e&&f===e){t.setMark("DragWithin","SameControl")}else{D=Date.now();f=e}var r=[];g=e;for(var i=0;i<20&&g;i++,g=g.$&&g.$().parent().control(0,true)){r=B(g,u,t);if(r.length){break}}if(t.getMark("DragWithin")!="SameControl"){s=r;if(l){l.setIndicatorConfig(null)}}if(!s.length){g=null}else if(!l){t.dragSession=l=y(t)}};o.onafterdragenter=function(t){if(!g||t.isMarked("NonDroppable")){s=[]}else if(t.getMark("DragWithin")!="SameControl"){s=s.filter(function(e){return e.fireDragEnter(t)})}var e=s[0];if(!e||e.getDropEffect()=="None"){A();p=""}else{N(t,e);p=U(t,e,g)}};o.onbeforedragover=function(t){var e=Date.now();if(e-D>=1e3){C(t,"longdragover");D=e}};o.onafterdragover=function(t){var e=s[0];if(!e||e.getDropEffect()=="None"){return}s.forEach(function(e){e.fireDragOver(t)});N(t,e);if(e&&e.getDropPosition(true)=="On"){return}p=U(t,e,g)};o.onbeforedrop=function(t){if(s.length){t.preventDefault()}};o.onafterdrop=function(t){s.forEach(function(e){e.fireDrop(t)});this.iDragEndTimer=window.requestAnimationFrame(this.onafterdragend.bind(this,t))};o.onafterdragend=function(t){this.iDragEndTimer=window.cancelAnimationFrame(this.iDragEndTimer);u.forEach(function(e){e.fireDragEnd(t)});w(a,"sapUiDnDDragging");n("html").removeClass("sapUiDnDNoScrolling");A();S()};r.addEventPreprocessor(o.preprocessEvent);r.addEventPostprocessor(o.postprocessEvent);return o},true);