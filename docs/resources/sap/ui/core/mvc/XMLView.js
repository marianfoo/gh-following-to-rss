/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./View","./XMLViewRenderer","./ViewType","sap/base/util/merge","sap/ui/base/ManagedObject","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Control","sap/ui/core/RenderManager","sap/ui/core/cache/CacheManager","sap/ui/model/resource/ResourceModel","sap/ui/util/XMLHelper","sap/ui/Global","sap/ui/VersionInfo","sap/base/strings/hash","sap/base/Log","sap/base/util/LoaderExtensions","sap/ui/performance/trace/Interaction","sap/ui/core/Core"],function(e,t,r,n,i,o,s,a,c,u,l,d,p,f,h,m,g,v){"use strict";var w=c.RenderPrefixes,y="XMLViewCacheError",C={};var P=a.extend("sap.ui.core.mvc.XMLAfterRenderingNotifier",{metadata:{library:"sap.ui.core"},renderer:{apiVersion:2,render:function(e,t){e.text("")}}});var M=t.extend("sap.ui.core.mvc.XMLView",{metadata:{library:"sap.ui.core",specialSettings:{containingView:{type:"sap.ui.core.mvc.XMLView",visibility:"hidden"},xmlNode:{type:"Element",visibility:"hidden"},cache:"Object",processingMode:{type:"sap.ui.core.mvc.XMLProcessingMode",visibility:"hidden"}},designtime:"sap/ui/core/designtime/mvc/XMLView.designtime"},renderer:r});sap.ui.xmlview=function(e,t){return sap.ui.view(e,t,n.XML)};M.create=function(e){var r=i({},e);r.viewContent=r.definition;r.async=true;r.type=n.XML;return t.create(r)};M._sType=n.XML;M.asyncSupport=true;M._bUseCache=sap.ui.getCore().getConfiguration().getViewCache()&&u._isSupportedEnvironment();function b(e){if(e.parseError.errorCode!==0){var t=e.parseError;throw new Error("The following problem occurred: XML parse Error for "+t.url+" code: "+t.errorCode+" reason: "+t.reason+" src: "+t.srcText+" line: "+t.line+" linepos: "+t.linepos+" filepos: "+t.filepos)}}function E(e,t){if(!t){throw new Error("mSettings must be given")}else if(t.viewName&&t.viewContent){throw new Error("View name and view content are given. There is no point in doing this, so please decide.")}else if((t.viewName||t.viewContent)&&t.xmlNode){throw new Error("View name/content AND an XML node are given. There is no point in doing this, so please decide.")}else if(!(t.viewName||t.viewContent)&&!t.xmlNode){throw new Error("Neither view name/content nor an XML node is given. One of them is required.")}else if(t.cache&&!(t.cache.keys&&t.cache.keys.length)){throw new Error("No cache keys provided. At least one is required.")}}function x(e,t){e.mProperties["viewContent"]=t.viewContent;var r=d.parse(t.viewContent);b(r);return r.documentElement}function N(e,t){if((e._resourceBundleName||e._resourceBundleUrl)&&(!t.models||!t.models[e._resourceBundleAlias])){var r=new l({bundleName:e._resourceBundleName,bundleUrl:e._resourceBundleUrl,bundleLocale:e._resourceBundleLocale,async:t.async});var n=r.getResourceBundle();if(n instanceof Promise){return n.then(function(){e.setModel(r,e._resourceBundleAlias)})}e.setModel(r,e._resourceBundleAlias)}}function _(e){e.oAfterRenderingNotifier=new P;e.oAfterRenderingNotifier.addDelegate({onAfterRendering:function(){e.onAfterRenderingBeforeChildren()}})}function V(e){var t=sap.ui.require("sap/ui/core/Component"),r;if(t){while(e){var n=t.getOwnerComponentFor(e);if(n){e=r=n}else{if(e instanceof t){r=e}e=e.getParent&&e.getParent()}}}return r}function R(e,t){var r=V(e),n=r?JSON.stringify(r.getManifest()):null,i=[];i=i.concat(D(e,r),I(),T(e),t.keys);return L(e,i).then(function(e){return{key:e+"("+h(n||"")+")",componentManifest:n,additionalData:t.additionalData}})}function A(e){return e}function L(e,t){return Promise.all(t).then(function(e){e=e.filter(function(e){return e!==C});if(e.every(A)){return e.join("_")}else{var t=new Error("Provided cache keys may not be empty or undefined.");t.name=y;return Promise.reject(t)}})}function D(e,t){var r=t&&t.getMetadata().getName();return[r||window.location.host+window.location.pathname,e.getId(),sap.ui.getCore().getConfiguration().getLanguageTag()].concat(t&&t.getActiveTerminologies()||[])}function T(e){var t=e.getPreprocessors(),r=e.getPreprocessorInfo(false),n=[];function i(e){n.push(e.preprocessor.then(function(e){if(e.getCacheKey){return e.getCacheKey(r)}else{return C}}))}for(var o in t){t[o].forEach(i)}return n}function I(){return f.load().then(function(e){var t="";if(!e.libraries){t=p.buildinfo.buildtime}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(e){m.warning("version info could not be retrieved","sap.ui.core.mvc.XMLView");m.debug(e);return""})}function X(e,t){var r=e.key;delete e.key;var n=e.additionalData;e.xml=d.serialize(t);if(n&&n.setAdditionalCacheData&&n.getAdditionalCacheData){e.additionalData=n.getAdditionalCacheData()}return u.set(r,e)}function S(e){return u.get(e.key).then(function(t){if(t&&t.componentManifest==e.componentManifest){t.xml=d.parse(t.xml,"application/xml").documentElement;if(t.additionalData){var r=e.additionalData;if(r&&r.setAdditionalCacheData&&r.getAdditionalCacheData){r.setAdditionalCacheData(t.additionalData)}else{m.error("Deprecated: Don't use an object reference for caching additional Data! Use a CacheDataProvider instead!");i(e.additionalData,t.additionalData)}}return t}})}M.prototype.initViewSettings=function(e){var r=this,n;function o(n){r._xContent=n;if(t._supportInfo){t._supportInfo({context:r._xContent,env:{caller:"view",viewinfo:i({},r),settings:i({},e||{}),type:"xmlview"}})}if(!r.isSubView()){s.parseViewAttributes(n,r)}else{delete e.controller}var o=N(r,e);if(o instanceof Promise){return o.then(function(){_(r)})}_(r)}function a(e,t){if(r.hasPreprocessor("viewxml")){return s.enrichTemplateIdsPromise(e,r,t).then(function(){return r.runPreprocessor("viewxml",e,!t)})}return e}function c(e){var t=v.notifyAsyncStep("VIEW PREPROCESSING");return r.runPreprocessor("xml",e).then(function(e){return a(e,true)}).finally(t)}function u(e){return g.loadResource(e,{async:true}).then(function(e){return e.documentElement})}function l(e,t){return u(e).then(c).then(function(e){if(t){X(t,e)}return e})}function d(e,t){return R(r,t).then(function(t){return S(t).then(function(r){if(!r){return l(e,t)}else{return r.xml}})}).catch(function(t){if(t.name===y){m.error(t.message,t.name,"sap.ui.core.mvc.XMLView");m.error("Processing the View without caching.","sap.ui.core.mvc.XMLView");return l(e)}else{return Promise.reject(t)}})}this._oContainingView=e.containingView||this;this._sProcessingMode=e.processingMode;if(this.oAsyncState){this.oAsyncState.suppressPreserve=true}E(this,e);if(e.viewName){var p=e.viewName.replace(/\./g,"/")+".view.xml";if(e.async){if(e.cache&&M._bUseCache){return d(p,e.cache).then(o)}else{return u(p).then(c).then(o)}}else{n=g.loadResource(p).documentElement}}else if(e.viewContent){if(e.viewContent.nodeType===window.Node.DOCUMENT_NODE){n=e.viewContent.documentElement}else{n=x(this,e)}}else if(e.xmlNode){n=e.xmlNode}if(e.async){return c(n).then(o)}else{n=this.runPreprocessor("xml",n,true);n=a(n,false);if(n&&typeof n.getResult==="function"){if(n.isRejected()){throw n.getResult()}n=n.getResult()}o(n)}};M.prototype.onBeforeRendering=function(){var e=this.getDomRef();if(e&&!c.isPreservedContent(e)){c.preserveContent(e,true)}t.prototype.onBeforeRendering.apply(this,arguments)};M.prototype.exit=function(){if(this.oAfterRenderingNotifier){this.oAfterRenderingNotifier.destroy()}t.prototype.exit.apply(this,arguments)};M.prototype.onControllerConnected=function(e,t){var r=this;function n(e){return o.runWithPreprocessors(e,{settings:r._fnSettingsPreprocessor})}if(!this.oAsyncState){this._aParsedContent=n(s.parseTemplate.bind(null,this._xContent,this,t))}else{var i=v.notifyAsyncStep("VIEW PROCESSING");return s.parseTemplatePromise(this._xContent,this,true,{fnRunWithPreprocessor:n}).then(function(e){r._aParsedContent=e;delete r.oAsyncState.suppressPreserve}).finally(i)}};M.prototype.getControllerName=function(){return this._controllerName};M.prototype.isSubView=function(){return this._oContainingView!=this};M.prototype.onAfterRenderingBeforeChildren=function(){if(this._$oldContent.length!==0){var t=this.getAggregation("content");if(t){for(var r=0;r<t.length;r++){var n=document.getElementById(w.Temporary+t[r].getId())||t[r].getDomRef()||document.getElementById(w.Invisible+t[r].getId());if(n){e(document.getElementById(w.Dummy+t[r].getId())).replaceWith(n)}}}e(document.getElementById(w.Temporary+this.getId())).replaceWith(this._$oldContent)}this._$oldContent=undefined};M.prototype._onChildRerenderedEmpty=function(t,r){e(r).replaceWith('<div id="'+w.Dummy+t.getId()+'" class="sapUiHidden"></div>');return true};M.registerPreprocessor=function(e,r,n,i,o,s){var a=this.getMetadata().getClass()._sType;if(typeof n==="string"){if(n!==a){throw new TypeError("View types other than "+a+" are not supported by XMLView.registerPreprocessor,"+" check View.registerPreprocessor instead")}}else{s=o;o=i;i=n}e=e.toUpperCase();if(M.PreprocessorType[e]){t.registerPreprocessor(M.PreprocessorType[e],r,a,i,o,s)}else{m.error('Preprocessor could not be registered due to unknown sType "'+e+'"',this.getMetadata().getName())}};M.PreprocessorType={XML:"xml",VIEWXML:"viewxml",CONTROLS:"controls"};M.registerPreprocessor("xml","sap.ui.core.util.XMLPreprocessor",true,true);return M});