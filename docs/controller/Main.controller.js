sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","@octokit/core","githubfollower/lib/firebase","sap/ui/core/Fragment","sap/ui/model/FilterOperator","sap/m/Token","sap/ui/model/Filter"],function(t,e,o,l,s,a,n,r,i){function u(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const d=u(t);const p=l["Octokit"];const h=s["initializeApp"];const g=s["getAuth"];const c=s["GithubAuthProvider"];const y=s["signInWithPopup"];const m=s["getFunctions"];const f=s["httpsCallable"];const P=d.extend("de.marianzeis.githubfollower.controller.Main",{loadSAPData:async function t(){let e=[];this.getModel("data").setProperty("/busySAPButton",true);this.getModel("data").setProperty("/busyOPMLButton",true);try{const t=m(this.app);console.log(t);const l=f(t,"helloWorld");const s=this.getModel("data").getProperty("/SAPCommunityUsername");if(!s||s===""){this.getModel("data").setProperty("/busySAPButton",false);this.getModel("data").setProperty("/busyOPMLButton",false);o.error("SAP Username is empty");return}const a=await l({userName:s});e=JSON.parse(a.data);console.log(e)}catch(t){this.getModel("data").setProperty("/busySAPButton",false);this.getModel("data").setProperty("/busyOPMLButton",false);o.error("Error while loading SAP Data (maybe User not found)");return}this.getModel("data").setProperty("/SAPFollowing",e.list_items);this.getModel("data").setProperty("/typeSAPButton","Success");this.getModel("data").setProperty("/busySAPButton",false);this.getModel("data").setProperty("/busyOPMLButton",false);this.getModel("data").setProperty("/OPMLButtonEnabled",true)},onInit:function t(){const o={apiKey:"AIzaSyCy1d13pYC79sOgUZnn4-sJ5VM9QY6TjqM",authDomain:"github-followers-281ea.firebaseapp.com",projectId:"github-followers-281ea",storageBucket:"github-followers-281ea.appspot.com",messagingSenderId:"576057379323",appId:"1:576057379323:web:4fb59feea548cdefa1235e"};this.app=h(o);this.auth=g(this.app);this.provider=new c;this.provider.setCustomParameters({allow_signup:"false"});this.token="";this.getView().setModel(new e({token:"",busyOPMLButton:false,typeGitHubButton:"Default",typeSAPButton:"Default",OPMLButtonEnabled:false}),"data")},signInToGitHub:function t(){this.githubSignInPopup(this.provider)},loadGitHubData:async function t(){this.getModel("data").setProperty("/busyGitHubButton",true);this.getModel("data").setProperty("/busyOPMLButton",true);const e=this.getModel("data").getProperty("/gitHubUsername");if(!e||e===""){this.getModel("data").setProperty("/busyGitHubButton",false);this.getModel("data").setProperty("/busyOPMLButton",false);o.error("GitHub Username is empty");return}let l=1;let s=[];let a=[];const n=new p({throttle:{onRateLimit:(t,e)=>{this.octokit.log.warn(`Request quota exhausted for request ${e.method} ${e.url}`);if(e.request.retryCount<=4){console.log(`Retrying after ${t} seconds!`);return true}},onAbuseLimit:(t,e)=>{this.octokit.log.warn(`Abuse detected for request ${e.method} ${e.url}`)}}});let r;try{r=await n.request(`GET /users/${e}/following`)}catch(t){if(t.status===404){this.getModel("data").setProperty("/busyGitHubButton",false);this.getModel("data").setProperty("/busyOPMLButton",false);o.error(`User ${e} not found`)}else{this.getModel("data").setProperty("/busyGitHubButton",false);this.getModel("data").setProperty("/busyOPMLButton",false);o.error(t.message)}}a=r.data;while(r.data.length>=30){l+=1;r=await n.request(`GET /users/${e}/following`,{page:l});a=[...a,...r.data]}this.getModel("data").setProperty("/GitHubFollowing",a);this.getModel("data").setProperty("/typeGitHubButton","Success");this.getModel("data").setProperty("/busyGitHubButton",false);this.getModel("data").setProperty("/busyOPMLButton",false);this.getModel("data").setProperty("/OPMLButtonEnabled",true)},opml:function t(){const e=this.getModel("data").getProperty("/GitHubFollowing")||[];const o=this.getModel("data").getProperty("/SAPFollowing")||[];const l=this.byId("multiInput").getTokens();let s=[];let a=[];let n=[];var r={title:"title-text",dateCreated:new Date(2014,2,9),ownerName:"azu"};for(var i=0;i<e.length;i++){s.push({text:e[i].login,title:e[i].login,type:"rss",xmlUrl:e[i].html_url+".atom",htmlUrl:e[i].html_url})}for(var i=0;i<o.length;i++){a.push({text:o[i].fullName,title:o[i].fullName,type:"rss",xmlUrl:`https://content.services.sap.com/feed?author=${o[i].userName}`,htmlUrl:o[i].profileUrl})}for(var i=0;i<l.length;i++){n.push({text:l[i].getText(),title:l[i].getText(),type:"rss",xmlUrl:`https://content.services.sap.com/feed?type=blogpost&amp;tags=${l[i].getKey()}`,htmlUrl:`https://blogs.sap.com/tags/${l[i].getKey()}`})}let u="<head><title>Sample OPML file for RSSReader</title></head>";let d=[];let p=[];let h=[];for(let t=0;t<s.length;t++){let e='<outline text="'+s[t].text+'" title="'+s[t].title+'" type="'+s[t].type+'" xmlUrl="'+s[t].xmlUrl+'" htmlUrl="'+s[t].htmlUrl+'" />';d.push(e)}for(let t=0;t<a.length;t++){let e='<outline text="'+a[t].text+'" title="'+a[t].title+'" type="'+a[t].type+'" xmlUrl="'+a[t].xmlUrl+'" htmlUrl="'+a[t].htmlUrl+'" />';p.push(e)}for(let t=0;t<n.length;t++){let e='<outline text="'+n[t].text+'" title="'+n[t].title+'" type="'+n[t].type+'" xmlUrl="'+n[t].xmlUrl+'" htmlUrl="'+n[t].htmlUrl+'" />';h.push(e)}let g="";if(p.length>0){g='<outline text="SAP Community Following" title="SAP Community Following">'+p+" </outline>"}if(d.length>0){g=g+'<outline text="GitHub Following" title="GitHub Following">'+d+" </outline>"}if(h.length>0){g=g+'<outline text="SAP Blogs" title="SAP Blogs">'+h+" </outline>"}let c='<?xml version="1.0" encoding="UTF-8"?><opml version="2.0">'+u+"<body>"+g+"</body>"+"</opml>";this.downloadFile("opml.xml",c)},githubSignInPopup:function t(e){const o=g();y(o,e).then(t=>{this.token=t._tokenResponse.oauthAccessToken;this.getModel("data").setProperty("/token",this.token)}).catch(t=>{var e=t.code;var o=t.message;var l=t.email;var s=t.credential})},downloadFile:function t(e,o){var l=document.createElement("a");l.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(o));l.setAttribute("download",e);l.style.display="none";document.body.appendChild(l);l.click();document.body.removeChild(l)},handleValueHelp:function t(e){var o=e.getSource().getValue(),l=this.getView();if(!this._pValueHelpDialog){this._pValueHelpDialog=a.load({id:l.getId(),name:"de.marianzeis.githubfollower.view.Dialog",controller:this}).then(function(t){l.addDependent(t);return t})}this._pValueHelpDialog.then(function(t){t.getBinding("items").filter([new i("title",n.Contains,o)]);let e=[];e.push(new sap.ui.model.Sorter("count",true));t.getBinding("items").sort(e);t.open(o)})},_handleValueHelpSearch:function t(e){var o=e.getParameter("value");var l=new i("title",n.Contains,o);var s=new i({path:"title",test:function(t){return t.toLowerCase().indexOf(o.toLowerCase())!==-1}});e.getSource().getBinding("items").filter(s)},onTokenUpdate:function t(e){this.getModel("data").setProperty("/OPMLButtonEnabled",true)},_handleValueHelpClose:function t(e){this.getModel("data").setProperty("/OPMLButtonEnabled",true);var o=e.getParameter("selectedItems"),l=this.byId("multiInput");if(o&&o.length>0){o.forEach(function(t){l.addToken(new r({text:t.getTitle(),key:t.getBindingContext("tags").getObject().tag}))})}}});return P});