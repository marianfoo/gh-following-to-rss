sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","@octokit/core","githubfollower/lib/firebase","sap/ui/core/Fragment","sap/ui/model/FilterOperator","sap/m/Token","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/core/util/File","sap/m/library"],function(t,e,o,n,s,i,l,a,r,u,d,p){function c(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const h=c(t);const g=n["Octokit"];const f=s["initializeApp"];const m=s["getAuth"];const y=s["GithubAuthProvider"];const P=s["signInWithPopup"];const b=s["getFunctions"];const w=s["httpsCallable"];const _=p["ButtonType"];const M=h.extend("de.marianzeis.githubfollower.controller.Main",{loadSAPData:async function t(){let e=[];this._dataModel.setProperty("/busySAPButton",true);this._dataModel.setProperty("/busyOPMLButton",true);try{const t=b(this.app);console.log(t);const n=w(t,"helloWorld");const s=this._dataModel.getProperty("/SAPCommunityUsername");if(!s||s===""){this._dataModel.setProperty("/busySAPButton",false);this._dataModel.setProperty("/busyOPMLButton",false);o.error("SAP Username is empty");return}const i=await n({userName:s});e=JSON.parse(i.data);console.log(e)}catch(t){this._dataModel.setProperty("/busySAPButton",false);this._dataModel.setProperty("/busyOPMLButton",false);o.error("Error while loading SAP Data (maybe User not found)");return}this._dataModel.setProperty("/SAPFollowing",e.list_items);this._dataModel.setProperty("/typeSAPButton",_.Success);this._dataModel.setProperty("/busySAPButton",false);this._dataModel.setProperty("/busyOPMLButton",false);this._dataModel.setProperty("/OPMLButtonEnabled",true)},onInit:function t(){const o={apiKey:"AIzaSyCy1d13pYC79sOgUZnn4-sJ5VM9QY6TjqM",authDomain:"github-followers-281ea.firebaseapp.com",projectId:"github-followers-281ea",storageBucket:"github-followers-281ea.appspot.com",messagingSenderId:"576057379323",appId:"1:576057379323:web:4fb59feea548cdefa1235e"};this.app=f(o);this.auth=m(this.app);this.provider=new y;this.provider.setCustomParameters({allow_signup:"false"});this.token="";this._dataModel=new e({token:"",busyOPMLButton:false,typeGitHubButton:"Default",typeSAPButton:"Default",OPMLButtonEnabled:false},true);this.getView().setModel(this._dataModel,"data")},signInToGitHub:function t(){this.githubSignInPopup(this.provider)},loadGitHubData:async function t(){this._dataModel.setProperty("/busyGitHubButton",true);this._dataModel.setProperty("/busyOPMLButton",true);const e=this.getModel("data").getProperty("/gitHubUsername");if(!e||e===""){this._dataModel.setProperty("/busyGitHubButton",false);this._dataModel.setProperty("/busyOPMLButton",false);o.error("GitHub Username is empty");return}let n=1;const s=[];let i=[];const l=new g({throttle:{onRateLimit:(t,e)=>{this.octokit.log.warn(`Request quota exhausted for request ${e.method} ${e.url}`);if(e.request.retryCount<=4){console.log(`Retrying after ${t} seconds!`);return true}},onAbuseLimit:(t,e)=>{this.octokit.log.warn(`Abuse detected for request ${e.method} ${e.url}`)}}});let a;try{a=await l.request(`GET /users/${e}/following`)}catch(t){if(t.status===404){this._dataModel.setProperty("/busyGitHubButton",false);this._dataModel.setProperty("/busyOPMLButton",false);o.error(`User ${e} not found`)}else{this._dataModel.setProperty("/busyGitHubButton",false);this._dataModel.setProperty("/busyOPMLButton",false);o.error(t.message)}}i=a.data;while(a.data.length>=30){n+=1;a=await l.request(`GET /users/${e}/following`,{page:n});i=[...i,...a.data]}this._dataModel.setProperty("/GitHubFollowing",i);this._dataModel.setProperty("/typeGitHubButton",_.Success);this._dataModel.setProperty("/busyGitHubButton",false);this._dataModel.setProperty("/busyOPMLButton",false);this._dataModel.setProperty("/OPMLButtonEnabled",true)},opml:function t(){const e=this._dataModel.getProperty("/GitHubFollowing")||[];const o=this._dataModel.getProperty("/SAPFollowing")||[];const n=this.byId("multiInput").getTokens();const s=this.byId("multiInputGroup").getTokens();const i=this.byId("multiInputYoutube").getTokens();const l=this.byId("multiInputSAPPodcasts").getTokens();const a=this.byId("SAPEventCheckbox").getSelected();const r=[];const u=[];const d=[];const p=[];const c=[];const h=[];const g={title:"title-text",dateCreated:new Date(2014,2,9),ownerName:"azu"};for(let t=0;t<e.length;t++){r.push({text:e[t].login,title:e[t].login,type:"rss",xmlUrl:e[t].html_url+".atom",htmlUrl:e[t].html_url})}for(let t=0;t<o.length;t++){u.push({text:o[t].fullName,title:o[t].fullName,type:"rss",xmlUrl:`https://content.services.sap.com/feed?author=${o[t].userName}`,htmlUrl:o[t].profileUrl})}for(let t=0;t<n.length;t++){d.push({text:n[t].getText(),title:n[t].getText(),type:"rss",xmlUrl:`https://content.services.sap.com/feed?type=blogpost&amp;tags=${n[t].getKey()}`,htmlUrl:`https://blogs.sap.com/tags/${n[t].getKey()}`})}for(let t=0;t<s.length;t++){const e=s[t].getKey().replace(/blog|forum$/,"");p.push({text:s[t].getText(),title:s[t].getText(),type:"rss",xmlUrl:`https://groups.community.sap.com/khhcw49343/rss/board?board.id=${s[t].getKey()}-board&amp;interaction.style=forum&amp;feeds.replies=true`,htmlUrl:`https://groups.community.sap.com/t5/${e}/gh-p/${e}`})}for(let t=0;t<i.length;t++){c.push({text:i[t].getText(),title:i[t].getText(),type:"rss",xmlUrl:`https://www.youtube.com/feeds/videos.xml?channel_id=${i[t].getKey()}`,htmlUrl:`https://www.youtube.com/channel/${i[t].getKey()}`})}for(let t=0;t<l.length;t++){h.push({text:l[t].getText(),title:l[t].getText(),type:"rss",xmlUrl:`https://podcast.opensap.info/${l[t].getKey()}/feed/mp3/`,htmlUrl:`https://podcast.opensap.info/${l[t].getKey()}/`})}const f="<head><title>Sample OPML file for RSSReader</title></head>";const m=this._generateOpmlLine(r);const y=this._generateOpmlLine(u);const P=this._generateOpmlLine(d);const b=this._generateOpmlLine(p);const w=this._generateOpmlLine(c);const _=this._generateOpmlLine(h);let M="";if(y.length>0){M='<outline text="SAP Community Following" title="SAP Community Following">'+y+" </outline>"}if(m.length>0){M=M+'<outline text="GitHub Following" title="GitHub Following">'+m+" </outline>"}if(P.length>0){M=M+'<outline text="SAP Blogs" title="SAP Blogs">'+P+" </outline>"}if(b.length>0){M=M+'<outline text="SAP Groups" title="SAP Groups">'+b+" </outline>"}if(a){M=M+'<outline text="SAP Group Events" title="SAP Group Events">'+'<outline text="SAP Group Events'+'" title="SAP Group Events'+'" type="rss'+'" xmlUrl="https://groups.community.sap.com/khhcw49343/rss/Category?category.id=events&amp;interaction.style=occasion'+'" htmlUrl="https://groups.community.sap.com/t5/events/ct-p/events'+'" />'+" </outline>"}if(w.length>0){M=M+'<outline text="SAP Youtube Channels" title="SAP Youtube Channels">'+w+" </outline>"}if(_.length>0){M=M+'<outline text="SAP Podcasts" title="SAP Podcasts">'+_+" </outline>"}const S='<?xml version="1.0" encoding="UTF-8"?><opml version="2.0">'+f+"<body>"+M+"</body>"+"</opml>";this.downloadFile("opml",S)},githubSignInPopup:function t(e){const o=m();P(o,e).then(t=>{this.token=t._tokenResponse.oauthAccessToken;this._dataModel.setProperty("/token",this.token)}).catch(t=>{const e=t.code;const o=t.message;const n=t.email;const s=t.credential})},downloadFile:function t(e,o){d.save(o,e,"xml","text/plain","utf-8")},handleValueHelp:function t(e){const o=e.getSource().getValue(),n=this.getView();if(!this._pValueHelpDialog){this._pValueHelpDialog=i.load({id:n.getId(),name:"de.marianzeis.githubfollower.view.Dialog",controller:this}).then(function(t){n.addDependent(t);return t})}this._pValueHelpDialog.then(function(t){t.getBinding("items").filter([new r("title",l.Contains,o)]);const e=[];e.push(new u("count",true));t.getBinding("items").sort(e);t.open(o)})},_handleValueHelpSearch:function t(e){const o=e.getParameter("value");const n=new r({path:"title",test:function(t){return t.toLowerCase().indexOf(o.toLowerCase())!==-1}});e.getSource().getBinding("items").filter(n)},onTokenUpdate:function t(e){this._dataModel.setProperty("/OPMLButtonEnabled",true)},_handleValueHelpClose:function t(e){this._dataModel.setProperty("/OPMLButtonEnabled",true);const o=e.getParameter("selectedItems"),n=this.byId("multiInput");if(o&&o.length>0){o.forEach(function(t){n.addToken(new a({text:t.getTitle(),key:t.getBindingContext("tags").getObject().tag}))})}},handleValueHelpGroup:function t(e){const o=e.getSource().getValue(),n=this.getView();if(!this._pValueHelpDialogGroup){this._pValueHelpDialogGroup=i.load({id:n.getId(),name:"de.marianzeis.githubfollower.view.DialogGroup",controller:this}).then(function(t){n.addDependent(t);return t})}this._pValueHelpDialogGroup.then(function(t){t.getBinding("items").filter([new r("title",l.Contains,o)]);const e=[];e.push(new u("count",true));t.getBinding("items").sort(e);t.open(o)})},_handleValueHelpSearchGroup:function t(e){const o=e.getParameter("value");const n=new r({path:"title",test:function(t){return t.toLowerCase().indexOf(o.toLowerCase())!==-1}});e.getSource().getBinding("items").filter(n)},onTokenUpdateGroup:function t(){this._dataModel.setProperty("/OPMLButtonEnabled",true)},onGithubUserNameInputEnter:async function t(){await this.loadGitHubData()},onSAPCommunityUserNameInputEnter:async function t(){await this.loadSAPData()},_handleValueHelpCloseGroup:function t(e){this._dataModel.setProperty("/OPMLButtonEnabled",true);const o=e.getParameter("selectedItems"),n=this.byId("multiInputGroup");if(o&&o.length>0){o.forEach(function(t){n.addToken(new a({text:t.getTitle(),key:t.getBindingContext("groups").getObject().tag}))})}},handleValueHelpYoutube:function t(e){const o=e.getSource().getValue(),n=this.getView();if(!this._pValueHelpDialogYoutube){this._pValueHelpDialogYoutube=i.load({id:n.getId(),name:"de.marianzeis.githubfollower.view.DialogYoutube",controller:this}).then(function(t){n.addDependent(t);return t})}this._pValueHelpDialogYoutube.then(function(t){t.getBinding("items").filter([new r("title",l.Contains,o)]);t.open(o)})},_handleValueHelpSearchYoutube:function t(e){const o=e.getParameter("value");const n=new r({path:"title",test:function(t){return t.toLowerCase().indexOf(o.toLowerCase())!==-1}});e.getSource().getBinding("items").filter(n)},onTokenUpdateYoutube:function t(e){this._dataModel.setProperty("/OPMLButtonEnabled",true)},_handleValueHelpCloseYoutube:function t(e){this._dataModel.setProperty("/OPMLButtonEnabled",true);const o=e.getParameter("selectedItems"),n=this.byId("multiInputYoutube");if(o&&o.length>0){o.forEach(function(t){n.addToken(new a({text:t.getTitle(),key:t.getBindingContext("youtube").getObject().id}))})}},handleValueHelpSAPPodcasts:function t(e){const o=e.getSource().getValue(),n=this.getView();if(!this._pValueHelpDialogSAPPodcasts){this._pValueHelpDialogSAPPodcasts=i.load({id:n.getId(),name:"de.marianzeis.githubfollower.view.DialogSAPPodcasts",controller:this}).then(function(t){n.addDependent(t);return t})}this._pValueHelpDialogSAPPodcasts.then(function(t){t.getBinding("items").filter([new r("title",l.Contains,o)]);t.open(o)})},_handleValueHelpSearchSAPPodcasts:function t(e){const o=e.getParameter("value");const n=new r({path:"title",test:function(t){return t.toLowerCase().indexOf(o.toLowerCase())!==-1}});e.getSource().getBinding("items").filter(n)},onTokenUpdateSAPPodcasts:function t(e){this._dataModel.setProperty("/OPMLButtonEnabled",true)},_handleValueHelpCloseSAPPodcasts:function t(e){this._dataModel.setProperty("/OPMLButtonEnabled",true);const o=e.getParameter("selectedItems"),n=this.byId("multiInputSAPPodcasts");if(o&&o.length>0){o.forEach(function(t){n.addToken(new a({text:t.getTitle(),key:t.getBindingContext("sap-podcasts").getObject().key}))})}},onCheckboxSelected:function t(){this._dataModel.setProperty("/OPMLButtonEnabled",true)},_generateOpmlLine:function t(e){const o=[];for(let t=0;t<e.length;t++){const n='<outline text="'+e[t].text+'" title="'+e[t].title+'" type="'+e[t].type+'" xmlUrl="'+e[t].xmlUrl+'" htmlUrl="'+e[t].htmlUrl+'" />';o.push(n)}return o}});return M});