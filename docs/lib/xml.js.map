{"version":3,"file":"xml.js","names":["escapeForXML","require","Stream","DEFAULT_INDENT","xml","input","options","indent","stream","output","interrupted","instant","delay","func","process","nextTick","append","interrupt","out","undefined","data","emit","add","value","last","format","resolve","end","readable","addXmlDeclaration","declaration","encoding","attr","version","standalone","_attr","replace","forEach","i","length","element","Array","prototype","slice","call","arguments","self","_elem","push","Error","that","icount","close","create_indent","character","count","join","indent_count","indent_spaces","name","values","keys","Object","indents","attributes","content","isStringContent","get_attributes","obj","key","attribute","_cdata","_name","pop","elem","len","proceed","shift","module","exports","Element"],"sources":["../../src/lib/xml.js"],"sourcesContent":["var escapeForXML = require('./escapeForXML');\nvar Stream = require('stream').Stream;\n\nvar DEFAULT_INDENT = '    ';\n\nfunction xml(input, options) {\n\n    if (typeof options !== 'object') {\n        options = {\n            indent: options\n        };\n    }\n\n    var stream      = options.stream ? new Stream() : null,\n        output      = \"\",\n        interrupted = false,\n        indent      = !options.indent ? ''\n                        : options.indent === true ? DEFAULT_INDENT\n                            : options.indent,\n        instant     = true;\n\n\n    function delay (func) {\n        if (!instant) {\n            func();\n        } else {\n            process.nextTick(func);\n        }\n    }\n\n    function append (interrupt, out) {\n        if (out !== undefined) {\n            output += out;\n        }\n        if (interrupt && !interrupted) {\n            stream = stream || new Stream();\n            interrupted = true;\n        }\n        if (interrupt && interrupted) {\n            var data = output;\n            delay(function () { stream.emit('data', data) });\n            output = \"\";\n        }\n    }\n\n    function add (value, last) {\n        format(append, resolve(value, indent, indent ? 1 : 0), last);\n    }\n\n    function end() {\n        if (stream) {\n            var data = output;\n            delay(function () {\n              stream.emit('data', data);\n              stream.emit('end');\n              stream.readable = false;\n              stream.emit('close');\n            });\n        }\n    }\n\n    function addXmlDeclaration(declaration) {\n        var encoding = declaration.encoding || 'UTF-8',\n            attr =  { version: '1.0', encoding: encoding };\n\n        if (declaration.standalone) {\n            attr.standalone = declaration.standalone\n        }\n\n        add({'?xml': { _attr: attr } });\n        output = output.replace('/>', '?>');\n    }\n\n    // disable delay delayed\n    delay(function () { instant = false });\n\n    if (options.declaration) {\n        addXmlDeclaration(options.declaration);\n    }\n\n    if (input && input.forEach) {\n        input.forEach(function (value, i) {\n            var last;\n            if (i + 1 === input.length)\n                last = end;\n            add(value, last);\n        });\n    } else {\n        add(input, end);\n    }\n\n    if (stream) {\n        stream.readable = true;\n        return stream;\n    }\n    return output;\n}\n\nfunction element (/*input, â€¦*/) {\n    var input = Array.prototype.slice.call(arguments),\n        self = {\n            _elem:  resolve(input)\n        };\n\n    self.push = function (input) {\n        if (!this.append) {\n            throw new Error(\"not assigned to a parent!\");\n        }\n        var that = this;\n        var indent = this._elem.indent;\n        format(this.append, resolve(\n            input, indent, this._elem.icount + (indent ? 1 : 0)),\n            function () { that.append(true) });\n    };\n\n    self.close = function (input) {\n        if (input !== undefined) {\n            this.push(input);\n        }\n        if (this.end) {\n            this.end();\n        }\n    };\n\n    return self;\n}\n\nfunction create_indent(character, count) {\n    return (new Array(count || 0).join(character || ''))\n}\n\nfunction resolve(data, indent, indent_count) {\n    indent_count = indent_count || 0;\n    var indent_spaces = create_indent(indent, indent_count);\n    var name;\n    var values = data;\n    var interrupt = false;\n\n    if (typeof data === 'object') {\n        var keys = Object.keys(data);\n        name = keys[0];\n        values = data[name];\n\n        if (values && values._elem) {\n            values._elem.name = name;\n            values._elem.icount = indent_count;\n            values._elem.indent = indent;\n            values._elem.indents = indent_spaces;\n            values._elem.interrupt = values;\n            return values._elem;\n        }\n    }\n\n    var attributes = [],\n        content = [];\n\n    var isStringContent;\n\n    function get_attributes(obj){\n        var keys = Object.keys(obj);\n        keys.forEach(function(key){\n            attributes.push(attribute(key, obj[key]));\n        });\n    }\n\n    switch(typeof values) {\n        case 'object':\n            if (values === null) break;\n\n            if (values._attr) {\n                get_attributes(values._attr);\n            }\n\n            if (values._cdata) {\n                content.push(\n                    ('<![CDATA[' + values._cdata).replace(/\\]\\]>/g, ']]]]><![CDATA[>') + ']]>'\n                );\n            }\n\n            if (values.forEach) {\n                isStringContent = false;\n                content.push('');\n                values.forEach(function(value) {\n                    if (typeof value == 'object') {\n                        var _name = Object.keys(value)[0];\n\n                        if (_name == '_attr') {\n                            get_attributes(value._attr);\n                        } else {\n                            content.push(resolve(\n                                value, indent, indent_count + 1));\n                        }\n                    } else {\n                        //string\n                        content.pop();\n                        isStringContent=true;\n                        content.push(escapeForXML(value));\n                    }\n\n                });\n                if (!isStringContent) {\n                    content.push('');\n                }\n            }\n        break;\n\n        default:\n            //string\n            content.push(escapeForXML(values));\n\n    }\n\n    return {\n        name:       name,\n        interrupt:  interrupt,\n        attributes: attributes,\n        content:    content,\n        icount:     indent_count,\n        indents:    indent_spaces,\n        indent:     indent\n    };\n}\n\nfunction format(append, elem, end) {\n\n    if (typeof elem != 'object') {\n        return append(false, elem);\n    }\n\n    var len = elem.interrupt ? 1 : elem.content.length;\n\n    function proceed () {\n        while (elem.content.length) {\n            var value = elem.content.shift();\n\n            if (value === undefined) continue;\n            if (interrupt(value)) return;\n\n            format(append, value);\n        }\n\n        append(false, (len > 1 ? elem.indents : '')\n            + (elem.name ? '</' + elem.name + '>' : '')\n            + (elem.indent && !end ? '\\n' : ''));\n\n        if (end) {\n            end();\n        }\n    }\n\n    function interrupt(value) {\n       if (value.interrupt) {\n           value.interrupt.append = append;\n           value.interrupt.end = proceed;\n           value.interrupt = false;\n           append(true);\n           return true;\n       }\n       return false;\n    }\n\n    append(false, elem.indents\n        + (elem.name ? '<' + elem.name : '')\n        + (elem.attributes.length ? ' ' + elem.attributes.join(' ') : '')\n        + (len ? (elem.name ? '>' : '') : (elem.name ? '/>' : ''))\n        + (elem.indent && len > 1 ? '\\n' : ''));\n\n    if (!len) {\n        return append(false, elem.indent ? '\\n' : '');\n    }\n\n    if (!interrupt(elem)) {\n        proceed();\n    }\n}\n\nfunction attribute(key, value) {\n    return key + '=' + '\"' + escapeForXML(value) + '\"';\n}\n\nmodule.exports = xml;\nmodule.exports.element = module.exports.Element = element;\n"],"mappings":"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"}