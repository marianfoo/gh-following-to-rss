const myVersion="0.4.24",myProductName="opmlPackage";exports.parse=parse;exports.stringify=stringify;exports.htmlify=getOutlineHtml;exports.markdownToOutline=markdownToOutline;exports.outlineToMarkdown=outlineToMarkdown;exports.expandInclude=expandInclude;exports.visitAll=visitAll;exports.expandIncludes=expandIncludes;const utils=require("daveutils");const opmltojs=require("opmltojs");const xml2js=require("xml2js");const request=require("request");function parse(e,n){function t(e){if(typeof e=="object"){return false}return true}function i(e){try{e.head.generator=myProductName+" v"+myVersion}catch(e){}}function s(e,n){var i=e["$"];if(i!==undefined){for(var u in i){if(u!="subs"){n[u]=i[u]}}delete e["$"]}for(var u in e){var r=e[u];if(t(r)){n[u]=r}else{if(u=="outline"){if(n.subs===undefined){n.subs=new Array}if(Array.isArray(r)){for(var o=0;o<r.length;o++){var l=new Object;s(r[o],l);n.subs.push(l)}}else{var l=new Object;s(r,l);n.subs.push(l)}}else{n[u]=new Object;s(r,n[u])}}}}var u={explicitArray:false};xml2js.parseString(e,u,function(e,u){if(e){n(e)}else{if(u==null){let e={message:"Internal error: xml2js.parseString returned null."};n(e)}else{var r={opml:new Object};s(u.opml,r.opml);i(r.opml);if(t(r.opml.head)){r.opml.head=new Object}if(t(r.opml.body)){r.opml.body=new Object}n(undefined,r)}}})}function stringify(e){var n=opmltojs.opmlify(e);return n}function getOutlineHtml(e){var n="";indentlevel=0;function t(e){n+=filledString("\t",indentlevel)+e+"\n"}function i(e){t("<ul>");indentlevel++;e.subs.forEach(function(e){t("<li>"+e.text+"</li>");if(e.subs!==undefined){i(e)}});t("</ul>");indentlevel--}i(e.opml.body);return n}function visitAll(e,n){function t(e){if(e.subs!==undefined){for(var i=0;i<e.subs.length;i++){var s=e.subs[i];if(!n(s)){return false}t(s)}}return true}t(e.opml.body)}function markdownToOutline(e,n){var t={opml:{head:{},body:{subs:new Array}}};if(n===undefined){n=new Object}if(n.flAddUnderscores===undefined){n.flAddUnderscores=true}e=e.toString();var i=e.split("\n"),s=0,u=new Array;var r=undefined,o=t.opml.body.subs;i.forEach(function(e){var t=0,i=true;while(e.length>0){if(e[0]!="\t"){break}t++;e=utils.stringDelete(e,1,1)}if(utils.beginsWith(e,"- ")){e=utils.stringDelete(e,1,2)}else{if(utils.stringContains(e,":: ")){let t=e.split(":: ");if(r!==undefined){var l=n.flAddUnderscores?"_"+t[0]:t[0];r[l]=t[1]}i=false}}if(t>s){u.push(o);r.subs=new Array;o=r.subs}else{if(t<s){var f=s-t;for(var d=1;d<=f;d++){o=u.pop()}}}if(i){var a={text:e};o.push(a);r=a;s=t}});return t}function outlineToMarkdown(e){var n="",t=0;function i(e){n+=utils.filledString("\t",t)+e+"\n"}function s(e){for(var n in e){if(n!="subs"&&n!="text"){if(utils.beginsWith(n,"_")){i(utils.stringDelete(n,1,1)+":: "+e[n])}}}}function u(e){e.subs.forEach(function(e){i("- "+e.text);s(e);if(e.subs!==undefined){t++;u(e);t--}})}u(e.opml.body);return n}function httpRequest(e,n){request(e,function(e,t,i){if(e){n(e)}else{var s=t.statusCode;if(s<200||s>299){const e="The request returned a status code of "+t.statusCode+".";n({message:e})}else{n(undefined,i)}}})}function expandInclude(e,n){if(e.type=="include"&&e.url!==undefined){httpRequest(e.url,function(e,t){if(e){n(e)}else{parse(t,function(e,t){if(e){n(e)}else{n(undefined,t.opml.body)}})}})}else{n(undefined,e)}}function expandIncludes(e,n){function t(n,i){var s=new Object,u=s,r=new Array,o;function l(e){var n=e.name;if(n===undefined){n=utils.innerCaseName(e.text)}return n}function f(){r[r.length]=o;o=u;if(o.subs===undefined){o.subs=new Array}}function d(e,n){var t=new Object;utils.copyScalars(e,t);o.subs[o.subs.length]=t;u=t}function a(){o=r[r.length-1];r.length--}function c(e,i){function s(e,n){console.log("readInclude: url == "+e.url);expandInclude(e,function(e,i){if(e){n(undefined)}else{t(i,function(e){n(e)})}})}function u(e,n,t){function i(e,r){if(e.subs!==undefined&&r<e.subs.length){var o=e.subs[r],f=n+l(o);if(!utils.getBoolean(o.iscomment)){if(o.type=="include"){d(o,f);s(o,function(n){if(n!==undefined){u(n,f+"/",function(){a();i(e,r+1)})}else{i(e,r+1)}})}else{d(o,f);if(o.subs!==undefined){u(o,f+"/",function(){a();i(e,r+1)})}else{i(e,r+1)}}}else{i(e,r+1)}}else{t()}}f();if(e.type=="include"){s(e,function(e){if(e!==undefined){i(e,0)}})}else{i(e,0)}}u(n,"",function(){a();i()})}c(e,function(){i(s)})}t(e.opml.body,function(t){var i={opml:{head:{},body:t}};utils.copyScalars(e.opml.head,i.opml.head);n(i)})}