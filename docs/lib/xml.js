var escapeForXML=require("./escapeForXML");var Stream=require("stream").Stream;var DEFAULT_INDENT="    ";function xml(e,t){if(typeof t!=="object"){t={indent:t}}var n=t.stream?new Stream:null,r="",i=false,a=!t.indent?"":t.indent===true?DEFAULT_INDENT:t.indent,o=true;function f(e){if(!o){e()}else{process.nextTick(e)}}function u(e,t){if(t!==undefined){r+=t}if(e&&!i){n=n||new Stream;i=true}if(e&&i){var a=r;f(function(){n.emit("data",a)});r=""}}function s(e,t){format(u,resolve(e,a,a?1:0),t)}function c(){if(n){var e=r;f(function(){n.emit("data",e);n.emit("end");n.readable=false;n.emit("close")})}}function l(e){var t=e.encoding||"UTF-8",n={version:"1.0",encoding:t};if(e.standalone){n.standalone=e.standalone}s({"?xml":{_attr:n}});r=r.replace("/>","?>")}f(function(){o=false});if(t.declaration){l(t.declaration)}if(e&&e.forEach){e.forEach(function(t,n){var r;if(n+1===e.length)r=c;s(t,r)})}else{s(e,c)}if(n){n.readable=true;return n}return r}function element(){var e=Array.prototype.slice.call(arguments),t={_elem:resolve(e)};t.push=function(e){if(!this.append){throw new Error("not assigned to a parent!")}var t=this;var n=this._elem.indent;format(this.append,resolve(e,n,this._elem.icount+(n?1:0)),function(){t.append(true)})};t.close=function(e){if(e!==undefined){this.push(e)}if(this.end){this.end()}};return t}function create_indent(e,t){return new Array(t||0).join(e||"")}function resolve(e,t,n){n=n||0;var r=create_indent(t,n);var i;var a=e;var o=false;if(typeof e==="object"){var f=Object.keys(e);i=f[0];a=e[i];if(a&&a._elem){a._elem.name=i;a._elem.icount=n;a._elem.indent=t;a._elem.indents=r;a._elem.interrupt=a;return a._elem}}var u=[],s=[];var c;function l(e){var t=Object.keys(e);t.forEach(function(t){u.push(attribute(t,e[t]))})}switch(typeof a){case"object":if(a===null)break;if(a._attr){l(a._attr)}if(a._cdata){s.push(("<![CDATA["+a._cdata).replace(/\]\]>/g,"]]]]><![CDATA[>")+"]]>")}if(a.forEach){c=false;s.push("");a.forEach(function(e){if(typeof e=="object"){var r=Object.keys(e)[0];if(r=="_attr"){l(e._attr)}else{s.push(resolve(e,t,n+1))}}else{s.pop();c=true;s.push(escapeForXML(e))}});if(!c){s.push("")}}break;default:s.push(escapeForXML(a))}return{name:i,interrupt:o,attributes:u,content:s,icount:n,indents:r,indent:t}}function format(e,t,n){if(typeof t!="object"){return e(false,t)}var r=t.interrupt?1:t.content.length;function i(){while(t.content.length){var i=t.content.shift();if(i===undefined)continue;if(a(i))return;format(e,i)}e(false,(r>1?t.indents:"")+(t.name?"</"+t.name+">":"")+(t.indent&&!n?"\n":""));if(n){n()}}function a(t){if(t.interrupt){t.interrupt.append=e;t.interrupt.end=i;t.interrupt=false;e(true);return true}return false}e(false,t.indents+(t.name?"<"+t.name:"")+(t.attributes.length?" "+t.attributes.join(" "):"")+(r?t.name?">":"":t.name?"/>":"")+(t.indent&&r>1?"\n":""));if(!r){return e(false,t.indent?"\n":"")}if(!a(t)){i()}}function attribute(e,t){return e+"="+'"'+escapeForXML(t)+'"'}module.exports=xml;module.exports.element=module.exports.Element=element;